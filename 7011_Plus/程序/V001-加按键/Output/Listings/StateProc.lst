C51 COMPILER V9.57.0.0   STATEPROC                                                         06/19/2020 09:50:37 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE STATEPROC
OBJECT MODULE PLACED IN ..\Output\Objects\StateProc.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\User\AppCode\ManageLayer\StateProc.c LARGE OPTIMIZE(8,SPEED) BROWSE INCD
                    -IR(..\User\AppCode\AppLayer;..\User\AppCode\DriverLayer;..\User\AppCode\ManageLayer;..\User\AppCode\WIFILayer;..\User\Sy
                    -sCode\Core) DEBUG OBJECTEXTEND PRINT(..\Output\Listings\StateProc.lst) OBJECT(..\Output\Objects\StateProc.obj)

line level    source

   1          #include "StateProc.h"
   2          #include "Typedef.h"
   3          #include "SysDataDef.h"
   4          #include "wifi.h"
   5          #include "LedProc.h"
   6          #include "Gpio.h"
   7          
   8          
   9          void ManageAdjust(void)
  10          {
  11   1              switch(Face.State)
  12   1          {
  13   2              case STEP_LOWPOWER:
  14   2                  
  15   2                  if(SwitchF || !NetSuccessF)
  16   2                  {
  17   3                      Face.CtrlTim = 0;
  18   3                      Face.State = STEP_IDLE;
  19   3                      SetDispVccP;                
  20   3                  }
  21   2                  break;
  22   2                  
  23   2              case STEP_IDLE:
  24   2                  
  25   2                  Dig[0] = 20;                // 显示 “0”
  26   2              
  27   2                  Dimmer.TmepValue = LightValTab[Dimmer.MinLightVal][0]; //控制启动时开始电压
  28   2              
  29   2                  if(!NetSuccessF)            // 如果配网不成功，3s后进入配网状态
  30   2                  {
  31   3                      if(++Face.CtrlTim > 3000)
  32   3                      {   
  33   4                          SetDispVccP;
  34   4                          ClrDimmerKeyF;
  35   4                          Face.CtrlTim = 0;
  36   4                          Face.State = STEP_NETWORK;
  37   4                      }
  38   3                  }
  39   2                  else
  40   2                  {
  41   3                      if(++Face.CtrlTim > 3000)
  42   3                      {
  43   4                          ClrDispVccP; 
  44   4                          Face.State = STEP_LOWPOWER; 
  45   4                      }
  46   3                  }
  47   2                      
  48   2                  if(SwitchF)
  49   2                  {
  50   3                      Face.CtrlTim = 0;
  51   3                      Face.State = STEP_OPENDRELAY;
  52   3                      SetDispVccP;
  53   3                      
C51 COMPILER V9.57.0.0   STATEPROC                                                         06/19/2020 09:50:37 PAGE 2   

  54   3                      if(NetSuccessF)
  55   3                      {
  56   4                          SetDpBrightF;   // 上报Dp值
  57   4                      }
  58   3                      
  59   3                  }
  60   2                  break;
  61   2              
  62   2              case STEP_OPENDRELAY:
  63   2                  OpenSwitchP;
  64   2                  Dig[0] = 20;                      // 显示 “0”
  65   2              
  66   2                  Face.CtrlTim++;
  67   2      
  68   2                  if(Face.CtrlTim == 100)           // 延时，防止继电器打开时灯闪烁
  69   2                  {
  70   3                      SetPwmTriggerF;
  71   3                  }
  72   2                  else if(Face.CtrlTim == 150)     // 启动时，稳住下最小暗度
  73   2                  {
  74   3                      Face.CtrlTim = 0;
  75   3                      Face.State = STEP_ADDBRIGHT;
  76   3                  }
  77   2                  break;
  78   2                  
  79   2              case STEP_ADDBRIGHT:
  80   2                  if(Dimmer.TmepValue < Dimmer.FaceValue)
  81   2                  {
  82   3                      if(Dimmer.TmepValue > LightValTab[Dimmer.MinLightVal][8])
  83   3                      {
  84   4                          if(++Face.CtrlTim > 20)
  85   4                          {
  86   5                              Face.CtrlTim = 0;
  87   5                              Dimmer.TmepValue ++;
  88   5                              Dig[0] = LedShowTrans(Dimmer.TmepValue);
  89   5                          }
  90   4                      }
  91   3                      else 
  92   3                      {
  93   4                          if(++Face.CtrlTim > 25)     // 控制启动灯亮度增加速率
  94   4                          {
  95   5                              Face.CtrlTim = 0;
  96   5                              Dimmer.TmepValue ++;
  97   5                              Dig[0] = LedShowTrans(Dimmer.TmepValue);
  98   5                          }
  99   4                      } 
 100   3                  }
 101   2                  else
 102   2                  {
 103   3                      Face.CtrlTim = 0;
 104   3                      Face.State = STEP_DIMMER;
 105   3                      ClrStartUpF;                // 清除启动标志
 106   3                  }
 107   2                  break;
 108   2              
 109   2              case STEP_DIMMER:
 110   2                  
 111   2                  Dig[0] = LedShowTrans(Dimmer.FaceValue);
 112   2                  
 113   2                  if(Dimmer.TmepValue > Dimmer.FaceValue)
 114   2                  {
 115   3                      if(++Face.CtrlTim > 25)     // 控制灯熄灭的速率
C51 COMPILER V9.57.0.0   STATEPROC                                                         06/19/2020 09:50:37 PAGE 3   

 116   3                      {
 117   4                          Face.CtrlTim = 0;
 118   4                          Dimmer.TmepValue--;
 119   4                      }
 120   3                  }
 121   2                  else if(Dimmer.TmepValue < Dimmer.FaceValue)
 122   2                  {
 123   3                      if(++Face.CtrlTim > 25)     // 控制灯熄灭的速率
 124   3                      {
 125   4                          Face.CtrlTim = 0;
 126   4                          Dimmer.TmepValue++;
 127   4                      }
 128   3                  }
 129   2                  
 130   2                  if(!NetSuccessF)    // 如果配网不成功，3s进入配网状态
 131   2                  {
 132   3                      Face.CtrlTim++;
 133   3                      if(Face.CtrlTim > 3000)
 134   3                      {
 135   4                          Face.CtrlTim = 0;
 136   4                          ClrDimmerKeyF;
 137   4                          
 138   4                          Face.State = STEP_NETWORK;
 139   4                      }
 140   3                  }
 141   2                  
 142   2                  if(!SwitchF)
 143   2                  {
 144   3                      Face.CtrlTim = 0;
 145   3                      Face.State = STEP_FALLBRIGHT;
 146   3                  }
 147   2                  break;
 148   2              
 149   2              case STEP_NETWORK:
 150   2                  SetAllFlashF;
 151   2              
 152   2                  if(wifi_work_state == SMART_CONFIG_STATE)    // 快闪 250ms
 153   2                  {
 154   3                      Dig[0] = 8;         // 8
 155   3                      LED_SetFlash(1);    // 快闪
 156   3      
 157   3                  }
 158   2                  else if(wifi_work_state == AP_STATE)         // 慢闪 1500ms
 159   2                  {
 160   3                      Dig[0] = 11;        // A
 161   3                      LED_SetFlash(0);    // 慢闪
 162   3                  }
 163   2                  else if(wifi_work_state == WIFI_NOT_CONNECTED)   // 慢闪 “-” 1500ms 
 164   2                  {
 165   3                      Dig[0] = 21;        // -
 166   3                      LED_SetFlash(0);    // 慢闪
 167   3                  }
 168   2                  
 169   2                  if(StartUpF)            // 配网状态进入启动状态
 170   2                  {
 171   3                      if(SwitchF)
 172   3                      {
 173   4                          Face.State = STEP_OPENDRELAY;
 174   4                      }
 175   3                      else
 176   3                      {
 177   4                          Face.State = STEP_FALLBRIGHT;
C51 COMPILER V9.57.0.0   STATEPROC                                                         06/19/2020 09:50:37 PAGE 4   

 178   4                      }
 179   3                      ClrAllFlashF;
 180   3                      Face.CtrlTim = 0;
 181   3                  }
 182   2                  
 183   2                  if(DimmerKeyF)          // 如果调光按键按下，回到调光状态
 184   2                  {
 185   3                      ClrAllFlashF;
 186   3                      Face.CtrlTim = 0;
 187   3                      Face.State = STEP_DIMMER; 
 188   3                  }
 189   2                  
 190   2                  if(NetSuccessF)
 191   2                  {
 192   3                      ClrAllFlashF;
 193   3                      Dig[0] = 17;        // 显示 ‘L’
 194   3                      if(++Face.CtrlTim > 4000)
 195   3                      {
 196   4                          Face.CtrlTim = 0;
 197   4                          Face.State = SwitchF ? STEP_DIMMER : STEP_IDLE; 
 198   4                      }
 199   3                  }
 200   2                  break;
 201   2      
 202   2              case STEP_FALLBRIGHT:
 203   2                  if(Dimmer.TmepValue > LightValTab[Dimmer.MinLightVal][8])
 204   2                  {
 205   3                      if(++Face.CtrlTim > 5)     // 控制灯熄灭的速率
 206   3                      {
 207   4                          Face.CtrlTim = 0;
 208   4                          
 209   4                          Dimmer.TmepValue --;
 210   4                          Dig[0] = LedShowTrans(Dimmer.TmepValue);
 211   4                      }
 212   3                  }
 213   2                  else if(Dimmer.TmepValue > LightValTab[Dimmer.MinLightVal][4])
 214   2                  {
 215   3                      if(++Face.CtrlTim > 20)     // 控制灯熄灭的速率
 216   3                      {
 217   4                          Face.CtrlTim = 0;
 218   4                          
 219   4                          Dimmer.TmepValue --;
 220   4                          Dig[0] = LedShowTrans(Dimmer.TmepValue);
 221   4                      }
 222   3                  }
 223   2                  else if(Dimmer.TmepValue > LightValTab[Dimmer.MinLightVal][0])
 224   2                  {
 225   3                      if(++Face.CtrlTim > 30)                 // 控制灯熄灭的速率
 226   3                      {
 227   4                          Face.CtrlTim = 0;
 228   4                          
 229   4                          Dimmer.TmepValue --;
 230   4                          Dig[0] = LedShowTrans(Dimmer.TmepValue);
 231   4                      }
 232   3                  }
 233   2                  else
 234   2                  {
 235   3                      if(++Face.CtrlTim > 200)                // 调到最暗时稳住
 236   3                      {
 237   4                          ClrPwmF;                
 238   4                          ClrPwmTriggerF;
 239   4                          Face.CtrlTim = 0;
C51 COMPILER V9.57.0.0   STATEPROC                                                         06/19/2020 09:50:37 PAGE 5   

 240   4                          Face.State = STEP_CLOSERELAY;
 241   4                      }
 242   3                  }
 243   2                  break;
 244   2                  
 245   2              case STEP_CLOSERELAY:
 246   2                  if(++Face.CtrlTim > 500)
 247   2                  {
 248   3                      Dig[0] = 20;
 249   3                      CloseSwitchP;
 250   3                      Face.CtrlTim = 0;
 251   3                      Face.State = STEP_IDLE;
 252   3                      ClrStartUpF;                
 253   3                  }
 254   2                  break;
 255   2                  
 256   2              default:
 257   2                  Face.CtrlTim = 0;
 258   2                  Face.State = STEP_IDLE;
 259   2                  break;
 260   2          }
 261   1      }
 262          
 263          void ManageNoAdjust(void)
 264          {
 265   1              switch(Face.State)
 266   1          {
 267   2              case STEP_LOWPOWER:
 268   2                  
 269   2                  if(SwitchF || !NetSuccessF)
 270   2                  {
 271   3                      Face.CtrlTim = 0;
 272   3                      Face.State = STEP_IDLE;
 273   3                      SetDispVccP;                
 274   3                  }
 275   2                  break;
 276   2                  
 277   2              case STEP_IDLE:
 278   2                  
 279   2                  Dig[0] = 20;                                // 显示 “0”
 280   2      
 281   2                  if(!NetSuccessF)                            // 如果配网不成功，3s后进入配网状态
 282   2                  {
 283   3                      if(++Face.CtrlTim > 3000)
 284   3                      {   
 285   4                          SetDispVccP;
 286   4                          ClrDimmerKeyF;
 287   4                          Face.CtrlTim = 0;
 288   4                          Face.State = STEP_NETWORK;
 289   4                      }
 290   3                  }
 291   2                  else
 292   2                  {
 293   3                      if(++Face.CtrlTim > 3000)
 294   3                      {
 295   4                          ClrDispVccP; 
 296   4                          Face.State = STEP_LOWPOWER; 
 297   4                      }
 298   3                  }
 299   2                      
 300   2                  if(SwitchF)
 301   2                  {
C51 COMPILER V9.57.0.0   STATEPROC                                                         06/19/2020 09:50:37 PAGE 6   

 302   3                      Face.CtrlTim = 0;
 303   3                      Face.State = STEP_OPENDRELAY;
 304   3                      SetDispVccP;
 305   3                      ClrPwmF;
 306   3                      
 307   3                      Dimmer.TmepValue = LightValTab[Dimmer.MinLightVal][9];
 308   3                      Dimmer.FaceValue = LightValTab[Dimmer.MinLightVal][9];
 309   3                      if(NetSuccessF)
 310   3                      {
 311   4                          SetDpBrightF;                       // 上报Dp值
 312   4                      }
 313   3                      
 314   3                  }
 315   2                  break;
 316   2                  
 317   2              case STEP_OPENDRELAY:
 318   2                  OpenSwitchP;
 319   2                  Dig[0] = 20;                                // 显示 “0”
 320   2              
 321   2                  Face.CtrlTim++;
 322   2      
 323   2                  if(Face.CtrlTim == 100)                     // 延时，防止继电器打开时灯闪烁
 324   2                  {
 325   3                      Dimmer.TmepValue = LightValTab[Dimmer.MinLightVal][9];      //控制启动时开始电压
 326   3                      Dimmer.FaceValue = LightValTab[Dimmer.MinLightVal][9];
 327   3                      SetPwmTriggerF;
 328   3                      ClrStartUpF;
 329   3                      Face.State = STEP_DIMMER;
 330   3                  }
 331   2                  break;
 332   2      
 333   2              case STEP_DIMMER:
 334   2                  
 335   2                  Dig[0] = LedShowTrans(Dimmer.FaceValue);
 336   2                  
 337   2                  if(!NetSuccessF)                            // 如果配网不成功，3s进入配网状态
 338   2                  {
 339   3                      Face.CtrlTim++;
 340   3                      if(Face.CtrlTim > 3000)
 341   3                      {
 342   4                          Face.CtrlTim = 0;                   
 343   4                          Face.State = STEP_NETWORK;
 344   4                      }
 345   3                  }
 346   2                  
 347   2                  if(!SwitchF)
 348   2                  {
 349   3                      Face.CtrlTim = 0;
 350   3                      Face.State = STEP_CLOSERELAY;
 351   3                  }
 352   2                  break;
 353   2              
 354   2              case STEP_NETWORK:
 355   2                  SetAllFlashF;
 356   2              
 357   2                  if(wifi_work_state == SMART_CONFIG_STATE)           // 快闪 250ms
 358   2                  {
 359   3                      Dig[0] = 8;                                     // 8
 360   3                      LED_SetFlash(1);                                // 快闪
 361   3      
 362   3                  }
 363   2                  else if(wifi_work_state == AP_STATE)                // 慢闪 1500ms
C51 COMPILER V9.57.0.0   STATEPROC                                                         06/19/2020 09:50:37 PAGE 7   

 364   2                  {
 365   3                      Dig[0] = 11;                                    // A
 366   3                      LED_SetFlash(0);                                // 慢闪
 367   3                  }
 368   2                  else if(wifi_work_state == WIFI_NOT_CONNECTED)      // 慢闪 “-” 1500ms 
 369   2                  {
 370   3                      Dig[0] = 21;                                    // -
 371   3                      LED_SetFlash(0);                                // 慢闪
 372   3                  }
 373   2                  
 374   2                  if(StartUpF)                                        // 配网状态进入启动状态
 375   2                  {
 376   3                      if(SwitchF)
 377   3                      {
 378   4                          Face.State = STEP_OPENDRELAY;
 379   4                      }
 380   3                      else
 381   3                      {
 382   4                          Face.State = STEP_CLOSERELAY;
 383   4                      }
 384   3                      ClrAllFlashF;
 385   3                      Face.CtrlTim = 0;
 386   3                  }
 387   2                  
 388   2                  if(NetSuccessF)
 389   2                  {
 390   3                      ClrAllFlashF;
 391   3                      Dig[0] = 17;                                    // 显示 ‘L’
 392   3                      if(++Face.CtrlTim > 4000)
 393   3                      {
 394   4                          Face.CtrlTim = 0;
 395   4                          Face.State = SwitchF ? STEP_DIMMER : STEP_IDLE; 
 396   4                      }
 397   3                  }
 398   2                  break;
 399   2                  
 400   2              case STEP_CLOSERELAY:
 401   2                  ClrPwmF;                
 402   2                  ClrPwmTriggerF;
 403   2                  
 404   2                  if(++Face.CtrlTim > 500)    // 关闭继电器后，再封波
 405   2                  {
 406   3                      Dig[0] = 20;
 407   3                      CloseSwitchP;
 408   3                      ClrStartUpF;
 409   3                      Face.CtrlTim = 0;
 410   3                      Face.State = STEP_IDLE;               
 411   3                  }
 412   2                  break;
 413   2                  
 414   2              default:
 415   2                  Face.CtrlTim = 0;
 416   2                  Face.State = STEP_IDLE;
 417   2                  break;
 418   2          }   
 419   1      }
 420          
 421          void StateProc(void)
 422          {
 423   1          if(AdjustLightF)
 424   1          {
 425   2             ManageAdjust(); 
C51 COMPILER V9.57.0.0   STATEPROC                                                         06/19/2020 09:50:37 PAGE 8   

 426   2          }
 427   1          else
 428   1          {
 429   2             ManageNoAdjust(); 
 430   2          }
 431   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2008    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
