C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE PROTOCOL
OBJECT MODULE PLACED IN ..\Output\Objects\protocol.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\User\AppCode\WIFILayer\protocol.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(
                    -..\User\AppCode\AppLayer;..\User\AppCode\DriverLayer;..\User\AppCode\ManageLayer;..\User\AppCode\WIFILayer;..\User\SysCo
                    -de\Core) DEBUG OBJECTEXTEND PRINT(..\Output\Listings\protocol.lst) OBJECT(..\Output\Objects\protocol.obj)

line level    source

   1          /****************************************Copyright (c)*************************
   2          **                               版权所有 (C), 2015-2020, 涂鸦科技
   3          **
   4          **                                 http://www.tuya.com
   5          **
   6          **--------------文件信息-------------------------------------------------------
   7          **文   件   名: protocol.c
   8          **描        述: 下发/上报数据处理函数
   9          **使 用 说 明 :
  10          
  11                            *******非常重要，一定要看哦！！！********
  12          
  13          ** 1、用户在此文件中实现数据下发/上报功能
  14          ** 2、DP的ID/TYPE及数据处理函数都需要用户按照实际定义实现
  15          ** 3、当开始某些宏定义后需要用户实现代码的函数内部有#err提示,完成函数后请
             -除该#err
  16          **
  17          **--------------当前版本修订---------------------------------------------------
  18          ** 版  本: v2.5.2
  19          ** 日　期: 2019年7月5日
  20          ** 描　述: 1:增加WiFi功能性测试（连接指定路由）
  21                     2:简化流服务过程，用户只需要调用流服务传输接口即可使用流服务
  22                     3:增加同步上报指令
  23                     4:增加获取当前wifi联网状态指令
  24                     5:增加获取格林时间指令
  25                     6:优化ota升级流程，启动ota升级时用户可以选择传输包大小
  26                     7:增加获取模块mac地址指令
  27                     
  28          ** 版  本: v2.5.1
  29          ** 日　期: 2018年10月27日
  30          ** 描　述: 1:默认关闭流服务功能
  31                     2:增加03协议wifi状态宏定义
  32                                 3:更新与修改部分函数注释
  33                             
  34          ** 版  本: v2.5.0
  35          ** 日　期: 2018年4月18日
  36          ** 描　述: 1:协议版本改为0x03
  37                     2:增加WIFI模组心跳关闭功能
  38                     3:增加天气功能
  39          
  40          ** 版  本: v2.3.8
  41          ** 日　期: 2018年1月17日
  42          ** 描　述: 1:变量添加volatile防止编译器优化
  43                     2:添加#error提示
  44          
  45          ** 版  本: v2.3.7
  46          ** 日　期: 2017年4月18日
  47          ** 描　述: 1:优化串口队列接收处理
  48                             
  49          ** 版  本: v2.3.6
  50          ** 日　期: 2016年7月21日
  51          ** 描　述: 1:修复获取本地时间错误
  52                     2:添加hex_to_bcd转换函数
C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 2   

  53                             
  54          ** 版  本: v2.3.5
  55          ** 日　期: 2016年6月3日
  56          ** 描　述: 1:修改返回协议版本为0x01
  57                     2:固件升级数据偏移量修改为4字节
  58          
  59          ** 版  本: v2.3.4
  60          ** 日　期: 2016年5月26日
  61          ** 描　述: 1:优化串口解析函数
  62                     2:优化编译器兼容性,取消enum类型定义
  63          
  64          ** 版  本: v2.3.3
  65          ** 日　期: 2016年5月24日
  66          ** 描　述: 1:修改mcu获取本地时间函数
  67                     2:添加wifi功能测试
  68          
  69          ** 版  本: v2.3.2
  70          ** 日　期: 2016年4月23日
  71          ** 描　述: 1:优化串口数据解析
  72                     2:优化MCU固件升级流程
  73                     3:优化上报流程
  74          
  75          ** 版  本: v2.3.1
  76          ** 日　期: 2016年4月15日
  77          ** 描　述: 1:优化串口数据解析
  78          
  79          ** 版  本: v2.3
  80          ** 日　期: 2016年4月14日
  81          ** 描　述: 1:支持MCU固件在线升级
  82          
  83          ** 版  本: v2.2
  84          ** 日　期: 2016年4月11日
  85          ** 描　述: 1:修改串口数据接收方式
  86          
  87          ** 版  本: v2.1
  88          ** 日　期: 2016年4月8日
  89          ** 描　述: 1:加入某些编译器不支持函数指针兼容选项
  90          
  91          ** 版  本: v2.0
  92          ** 日　期: 2016年3月29日
  93          ** 描　述: 1:优化代码结构
  94                     2:节省RAM空间
  95          **
  96          **-----------------------------------------------------------------------------
  97          ******************************************************************************/
  98          #include "wifi.h"
  99          #include "SysDataDef.h"
 100          #include "WifiProc.h"
 101          
 102          #ifdef WEATHER_ENABLE
              /******************************************************************************
                                      天气数据参数选择数组
                        **用户可以自定义需要的参数，注释或者取消注释即可，注意更改**        
             - 
              ******************************************************************************/
              const char weather_choose[WEATHER_CHOOSE_CNT][10] = {
                  "temp",
                  "humidity",
                  "condition",
                  "pm25",
                  /*"pressure",
                  "realFeel",
C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 3   

                  "uvi",
                  "tips",
                  "windDir",
                  "windLevel",
                  "windSpeed",
                  "sunRise",
                  "sunSet",
                  "aqi",
                  "so2 ",
                  "rank",
                  "pm10",
                  "o3",
                  "no2",
                  "co",*/
               };
              #endif
 130          
 131          /******************************************************************************
 132                                          移植须知:
 133          1:MCU必须在while中直接调用mcu_api.c内的wifi_uart_service()函数
 134          2:程序正常初始化完成后,建议不进行关串口中断,如必须关中断,关中断时间必须
             -,关中断会引起串口数据包丢失
 135          3:请勿在中断/定时器中断内调用上报函数
 136          ******************************************************************************/
 137          
 138                   
 139          /******************************************************************************
 140                                        第一步:初始化
 141          1:在需要使用到wifi相关文件的文件中include "wifi.h"
 142          2:在MCU初始化中调用mcu_api.c文件中的wifi_protocol_init()函数
 143          3:将MCU串口单字节发送函数填入protocol.c文件中uart_transmit_output函数内,并删除#error
 144          4:在MCU串口接收函数中调用mcu_api.c文件内的uart_receive_input函数,并将接收到的字节
             -为参数传入
 145          5:单片机进入while循环后调用mcu_api.c文件内的wifi_uart_service()函数
 146          ******************************************************************************/
 147          
 148          /******************************************************************************
 149                                  1:dp数据点序列类型对照表
 150                    **此为自动生成代码,如在开发平台有相关修改请重新下载MCU_SDK**         
 151          ******************************************************************************/
 152          const DOWNLOAD_CMD_S download_cmd[] =
 153          {
 154            {DPID_LED_SWITCH, DP_TYPE_BOOL},
 155            {DPID_BRIGHT_VALUE, DP_TYPE_VALUE},
 156          };
 157          
 158          
 159          /******************************************************************************
 160                                     2:串口单字节发送函数
 161          请将MCU串口发送函数填入该函数内,并将接收到的数据作为参数传入串口发送函数
 162          ******************************************************************************/
 163          
 164          /*****************************************************************************
 165          函数名称 : uart_transmit_output
 166          功能描述 : 发数据处理
 167          输入参数 : value:串口收到字节数据
 168          返回参数 : 无
 169          使用说明 : 请将MCU串口发送函数填入该函数内,并将接收到的数据作为参数传入串
             -口发送函数
 170          *****************************************************************************/
 171          void uart_transmit_output(unsigned char value)
 172          {
C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 4   

 173   1      //  #error "请将MCU串口发送函数填入该函数,并删除该行"
 174   1      /*
 175   1        //示例:
 176   1        extern void Uart_PutChar(unsigned char value);
 177   1        Uart_PutChar(value);                                  //串口发送函数
 178   1      */
 179   1              
 180   1        extern void Uart_PutChar(unsigned char value);
 181   1        Uart_PutChar(value);                           //串口发送函数   
 182   1      }
 183          /******************************************************************************
 184                                     第二步:实现具体用户函数
 185          1:APP下发数据处理
 186          2:数据上报处理
 187          ******************************************************************************/
 188          
 189          /******************************************************************************
 190                                      1:所有数据上报处理
 191          当前函数处理全部数据上报(包括可下发/可上报和只上报)
 192            需要用户按照实际情况实现:
 193            1:需要实现可下发/可上报数据点上报
 194            2:需要实现只上报数据点上报
 195          此函数为MCU内部必须调用
 196          用户也可调用此函数实现全部数据上报
 197          ******************************************************************************/
 198          
 199          //自动化生成数据上报函数
 200          
 201          /*****************************************************************************
 202          函数名称 : all_data_update
 203          功能描述 : 系统所有dp点信息上传,实现APP和muc数据同步
 204          输入参数 : 无
 205          返回参数 : 无
 206          使用说明 : 此函数SDK内部需调用;
 207                     MCU必须实现该函数内数据上报功能;包括只上报和可上报可下发型数据
 208          *****************************************************************************/
 209          void all_data_update(void)
 210          {
 211   1      //  #error "请在此处理可下发可上报数据及只上报数据示例,处理完成后删除该行"
 212   1          /* 
 213   1          //此代码为平台自动生成，请按照实际数据修改每个可下发可上报函数和只上
             -函数
 214   1          mcu_dp_bool_update(DPID_LED_SWITCH,当前开关); //BOOL型数据上报;
 215   1          mcu_dp_value_update(DPID_BRIGHT_VALUE,当前亮度); //VALUE型数据上报;
 216   1      
 217   1          */
 218   1              extern u8 Cloud;
 219   1              extern u8 Digital;
 220   1              extern bit Logic_Switchs_Value;
 221   1          
 222   1              Data_s  Switch;
 223   1      
 224   1              Switch.led_switch               = Dimmer.FaceValue;
 225   1              Switch.bright_value     = SwitchF ? 1 : 0;
 226   1      
 227   1              mcu_dp_bool_update(DPID_LED_SWITCH,Switch.led_switch);          //BOOL型数据上报;
 228   1              mcu_dp_value_update(DPID_BRIGHT_VALUE,Switch.bright_value);     //VALUE型数据上报; 
 229   1      }
 230          
 231          
 232          /******************************************************************************
 233                                          WARNING!!!    
C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 5   

 234                                      2:所有数据上报处理
 235          自动化代码模板函数,具体请用户自行实现数据处理
 236          ******************************************************************************/
 237          
 238          
 239          /*****************************************************************************
 240          函数名称 : dp_download_led_switch_handle
 241          功能描述 : 针对DPID_LED_SWITCH的处理函数
 242          输入参数 : value:数据源数据
 243                  : length:数据长度
 244          返回参数 : 成功返回:SUCCESS/失败返回:ERROR
 245          使用说明 : 可下发可上报类型,需要在处理完数据后上报处理结果至app
 246          *****************************************************************************/
 247          static unsigned char dp_download_led_switch_handle(const unsigned char value[], unsigned short length)
 248          {
 249   1          //示例:当前DP类型为BOOL
 250   1          unsigned char ret;
 251   1          unsigned char led_switch;
 252   1      
 253   1          led_switch = mcu_get_dp_download_bool(value,length);
 254   1      
 255   1          if(led_switch)
 256   1          {
 257   2              SetSwitchF;
 258   2              SetStartUpF;
 259   2          }
 260   1          else
 261   1          {
 262   2              ClrSwitchF;
 263   2              SetStartUpF;
 264   2          }
 265   1      
 266   1          //处理完DP数据后应有反馈
 267   1          ret = mcu_dp_bool_update(DPID_LED_SWITCH,led_switch);
 268   1      
 269   1          if(ret == SUCCESS)
 270   1          return SUCCESS;
 271   1          else
 272   1          return ERROR;
 273   1      }
 274          /*****************************************************************************
 275          函数名称 : dp_download_bright_value_handle
 276          功能描述 : 针对DPID_BRIGHT_VALUE的处理函数
 277          输入参数 : value:数据源数据
 278                  : length:数据长度
 279          返回参数 : 成功返回:SUCCESS/失败返回:ERROR
 280          使用说明 : 可下发可上报类型,需要在处理完数据后上报处理结果至app
 281          *****************************************************************************/
 282          static unsigned char dp_download_bright_value_handle(const unsigned char value[], unsigned short length)
 283          {
 284   1        //示例:当前DP类型为VALUE
 285   1        unsigned char ret;
 286   1        unsigned long bright_value;
 287   1        
 288   1        bright_value = mcu_get_dp_download_value(value,length);
 289   1      
 290   1        Dimmer.FaceValue = BrightApp2Mcu(bright_value);
 291   1          
 292   1        if(Dimmer.FaceValue < LightValTab[Dimmer.MinLightVal][0])
 293   1        {
 294   2          Dimmer.FaceValue = LightValTab[Dimmer.MinLightVal][0];
 295   2        }
C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 6   

 296   1        
 297   1        if(Dimmer.FaceValue >= 150) 
 298   1        {
 299   2          Dimmer.FaceValue = LightValTab[Dimmer.MinLightVal][9];
 300   2        }      
 301   1            
 302   1        //处理完DP数据后应有反馈
 303   1        ret = mcu_dp_value_update(DPID_BRIGHT_VALUE,bright_value);
 304   1          
 305   1        if(ret == SUCCESS)
 306   1          return SUCCESS;
 307   1        else
 308   1          return ERROR;
 309   1      }
 310          
 311          
 312          /******************************************************************************
 313                                          WARNING!!!                     
 314          此代码为SDK内部调用,请按照实际dp数据实现函数内部数据
 315          ******************************************************************************/
 316          #ifdef SUPPORT_GREEN_TIME
              /*****************************************************************************
              函数名称 : mcu_get_greentime
              功能描述 : 获取到的格林时间
              输入参数 : 无
              返回参数 : 无
              使用说明 : MCU需要自行实现该功能
              *****************************************************************************/
              void mcu_get_greentime(unsigned char time[])
              {
              #error "请自行完成相关代码,并删除该行"
                /*
                time[0]为是否获取时间成功标志，为 0 表示失败，为 1表示成功
                time[1] 为 年 份 , 0x00 表 示2000 年
                time[2]为月份，从 1 开始到12 结束
                time[3]为日期，从 1 开始到31 结束
                time[4]为时钟，从 0 开始到23 结束
                time[5]为分钟，从 0 开始到59 结束
                time[6]为秒钟，从 0 开始到59 结束
               */
                if(time[0] == 1)
                {
                  //正确接收到wifi模块返回的格林数据
                }
                else
                {
                      //获取格林时间出错,有可能是当前wifi模块未联网
                }
              }
              #endif
 346          
 347          #ifdef SUPPORT_MCU_RTC_CHECK
              /*****************************************************************************
              函数名称 : mcu_write_rtctime
              功能描述 : MCU校对本地RTC时钟
              输入参数 : 无
              返回参数 : 无
              使用说明 : MCU需要自行实现该功能
              *****************************************************************************/
              void mcu_write_rtctime(unsigned char time[])
              {
                #error "请自行完成RTC时钟写入代码,并删除该行"
C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 7   

                /*
                time[0]为是否获取时间成功标志，为 0 表示失败，为 1表示成功
                time[1] 为 年 份 , 0x00 表 示2000 年
                time[2]为月份，从 1 开始到12 结束
                time[3]为日期，从 1 开始到31 结束
                time[4]为时钟，从 0 开始到23 结束
                time[5]为分钟，从 0 开始到59 结束
                time[6]为秒钟，从 0 开始到59 结束
                time[7]为星期，从 1 开始到 7 结束，1代表星期一
               */
                if(time[0] == 1)
                {
                  //正确接收到wifi模块返回的本地时钟数据 
                       
                }
                else
                {
                      //获取本地时钟数据出错,有可能是当前wifi模块未联网
                }
              }
              #endif
 379          
 380          #ifdef WIFI_TEST_ENABLE
 381          /*****************************************************************************
 382          函数名称 : wifi_test_result
 383          功能描述 : wifi功能测试反馈
 384          输入参数 : result:wifi功能测试结果;0:失败/1:成功
 385                     rssi:测试成功表示wifi信号强度/测试失败表示错误类型
 386          返回参数 : 无
 387          使用说明 : MCU需要自行实现该功能
 388          *****************************************************************************/
 389          void wifi_test_result(unsigned char result,unsigned char rssi)
 390          {
 391   1      //  #error "请自行实现wifi功能测试成功/失败代码,完成后请删除该行"
 392   1        if(result == 0)
 393   1        {
 394   2          //测试失败
 395   2          if(rssi == 0x00)
 396   2          {
 397   3            //未扫描到名称为tuya_mdev_test路由器,请检查
 398   3          }
 399   2          else if(rssi == 0x01)
 400   2          {
 401   3            //模块未授权
 402   3      //        LED7Codes(2); 
 403   3          }
 404   2        }
 405   1        else
 406   1        {
 407   2          //测试成功
 408   2          //rssi为信号强度(0-100, 0信号最差，100信号最强)
 409   2          if(rssi > 30)
 410   2          {
 411   3              SetWifiTestF;   // 设置产测成功
 412   3          }     
 413   2        }
 414   1        
 415   1      }
 416          #endif
 417          
 418          #ifdef WIFI_CONNECT_TEST_ENABLE
              /*****************************************************************************
C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 8   

              函数名称 : wifi_connect_test_result
              功能描述 : 路由信息接收结果通知
              输入参数 : result:模块是否成功接收到正确的路由信息;0:失败/1:成功
              返回参数 : 无
              使用说明 : MCU需要自行实现该功能
              *****************************************************************************/
              void wifi_connect_test_result(unsigned char result)
              {
                #error "请自行实现wifi功能测试成功/失败代码,完成后请删除该行"
                if(result == 0)
                {
                  //路由信息接收失败，请检查发出的路由信息包是否是完整的JSON数据包
                }
                else
                {
                  //路由信息接收成功，产测结果请注意WIFI_STATE_CMD指令的wifi工作状态
                }
              }
              #endif
 439          
 440          #ifdef GET_MODULE_MAC_ENABLE
              /*****************************************************************************
              函数名称 : mcu_write_rtctime
              功能描述 : MCU校对本地RTC时钟
              输入参数 : mac：mac[0]为是否获取mac成功标志，0x00 表示成功，为0x01表示失败
                mac[1]~mac[6]:当获取 MAC地址标志位如果mac[0]为成功，则表示模块有效的MAC地址
              返回参数 : 无
              使用说明 : MCU需要自行实现该功能
              *****************************************************************************/
              void mcu_get_mac(unsigned char mac[])
              {
                #error "请自行完成mac获取代码,并删除该行"
                /*
                mac[0]为是否获取mac成功标志，0x00 表示成功，为0x01表示失败
                mac[1]~mac[6]:当获取 MAC地址标志位如果mac[0]为成功，则表示模块有效的MAC地址
               */
               
                if(mac[0] == 1)
                {
                      //获取mac出错
                }
                else
                {
                  //正确接收到wifi模块返回的mac地址 
                }
              }
              #endif
 467          
 468          
 469          
 470          #ifdef GET_WIFI_STATUS_ENABLE
              /*****************************************************************************
              函数名称 : mcu_write_rtctime
              功能描述 : 获取 WIFI 状态结果
              输入参数 : result:指示 WIFI 工作状态
                         0x00:wifi状态 1 smartconfig 配置状态
                         0x01:wifi状态 2 AP 配置状态
                         0x02:wifi状态 3 WIFI 已配置但未连上路由器
                         0x03:wifi状态 4 WIFI 已配置且连上路由器
                         0x04:wifi状态 5 已连上路由器且连接到云端
                         0x05:wifi状态 6 WIFI 设备处于低功耗模式
              返回参数 : 无
C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 9   

              使用说明 : MCU需要自行实现该功能
              *****************************************************************************/
              void get_wifi_status(unsigned char result)
              {
                #error "请自行完成mac获取代码,并删除该行"
               
                switch(result) {
                  case 0:
                    //wifi工作状态1
                    break;
                
                  case 1:
                    //wifi工作状态2
                    break;
                    
                  case 2:
                    //wifi工作状态3
                    break;
                    
                  case 3:
                    //wifi工作状态4
                    break;
                    
                  case 4:
                    //wifi工作状态5
                    break;
                    
                  case 5:
                    //wifi工作状态6
                    break;
                    
                  default:
                  break;
                }
              }
              #endif
 518          
 519          #ifdef MCU_DP_UPLOAD_SYN
              /*****************************************************************************
              函数名称 : get_upload_syn_result
              功能描述 : 状态同步上报结果
              输入参数 : result:0x00失败  0x01成功
              返回参数 : 无
              使用说明 : MCU需要自行实现该功能
              *****************************************************************************/
              void get_upload_syn_result(unsigned char result)
              {
                #error "请自行完成mac获取代码,并删除该行"
                /*
                mac[0]为是否获取mac成功标志，0x00 表示成功，为0x01表示失败
                mac[1]~mac[6]:当获取 MAC地址标志位如果mac[0]为成功，则表示模块有效的MAC地址
               */
               
                if(result == 0)
                {
                      //获取mac出错
                }
                else
                {
                  //正确接收到wifi模块返回的mac地址 
                }
              }
C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 10  

              #endif
 545          
 546          
 547          #ifdef SUPPORT_MCU_FIRM_UPDATE
              /*****************************************************************************
              函数名称 : upgrade_package_choose
              功能描述 : 升级包大小选择
              输入参数 : package_sz:升级包大小
                         0x00：默认 256byte
                         0x01：512byte 
                         0x02：1024byte
              
              返回参数 : 无
              *****************************************************************************/
              void upgrade_package_choose(unsigned char package_sz)
              {
                unsigned short length = 0;
                length = set_wifi_uart_byte(length,package_sz);
                wifi_uart_write_frame(UPDATE_START_CMD,length);
              }
              
              
              
              /*****************************************************************************
              函数名称 : mcu_firm_update_handle
              功能描述 : MCU进入固件升级模式
              输入参数 : value:固件缓冲区
                         position:当前数据包在于固件位置
                         length:当前固件包长度(固件包长度为0时,表示固件包发送完成)
              返回参数 : 无
              使用说明 : MCU需要自行实现该功能
              *****************************************************************************/
              unsigned char mcu_firm_update_handle(const unsigned char value[],unsigned long position,unsigned short len
             -gth)
              {
                #error "请自行完成MCU固件升级代码,完成后请删除该行"
                if(length == 0)
                {
                  //固件数据发送完成
                  
                }
                else
                {
                  //固件数据处理
                }
                
                return SUCCESS;
              }
              #endif
 592          /******************************************************************************
 593                                          WARNING!!!                     
 594          以下函数用户请勿修改!!
 595          ******************************************************************************/
 596          
 597          /*****************************************************************************
 598          函数名称 : dp_download_handle
 599          功能描述 : dp下发处理函数
 600          输入参数 : dpid:DP序号
 601                     value:dp数据缓冲区地址
 602                     length:dp数据长度
 603          返回参数 : 成功返回:SUCCESS/失败返回:ERRO
 604          使用说明 : 该函数用户不能修改
C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 11  

 605          *****************************************************************************/
 606          unsigned char dp_download_handle(unsigned char dpid,const unsigned char value[], unsigned short length)
 607          {
 608   1        /*********************************
 609   1        当前函数处理可下发/可上报数据调用                    
 610   1        具体函数内需要实现下发数据处理
 611   1        完成用需要将处理结果反馈至APP端,否则APP会认为下发失败
 612   1        ***********************************/
 613   1        unsigned char ret;
 614   1        switch(dpid)
 615   1        {
 616   2          case DPID_LED_SWITCH:
 617   2            //开关处理函数
 618   2            ret = dp_download_led_switch_handle(value,length);
 619   2            break;
 620   2          case DPID_BRIGHT_VALUE:
 621   2            //亮度处理函数
 622   2            ret = dp_download_bright_value_handle(value,length);
 623   2            break;
 624   2      
 625   2        default:
 626   2          break;
 627   2        }
 628   1        return ret;
 629   1      }
 630          /*****************************************************************************
 631          函数名称 : get_download_cmd_total
 632          功能描述 : 获取所有dp命令总和
 633          输入参数 : 无
 634          返回参数 : 下发命令总和
 635          使用说明 : 该函数用户不能修改
 636          *****************************************************************************/
 637          unsigned char get_download_cmd_total(void)
 638          {
 639   1        return(sizeof(download_cmd) / sizeof(download_cmd[0]));
 640   1      }
 641          
 642          #ifdef WEATHER_ENABLE
              
              /*****************************************************************************
              函数名称 : weather_open_return
              功能描述 : 打开天气功能返回用户自处理函数
              输入参数 : 1:res:打开天气功能返回结果，1:成功；0：失败
              
              返回参数 : 无
              *****************************************************************************/
              void weather_open_return_handle(unsigned char res, unsigned char err)
              {
                #error "请自行完成M打开天气功能返回数据处理代码,完成后请删除该行"
                unsigned char err_num = 0;
                
                if(res == 1)
                {
                  //打开天气返回成功
                }
                else if(res == 0)
                {
                  //打开天气返回失败
                  err_num = err;//获取错误码
                }
              }
              
C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 12  

              /*****************************************************************************
              函数名称 : weather_data_user_handle
              功能描述 : 天气数据用户自处理函数
              输入参数 : name:参数名
                         type:参数类型，0：int型；1：string型
                         data:参数值的地址
              返回参数 : 无
              *****************************************************************************/
              void weather_data_user_handle(char *name, unsigned char type, char *data)
              {
                #error "这里仅给出示例，请自行完善天气数据处理代码,完成后请删除该行"
                int value_int;
                char value_string[50];//由于有的参数内容较多，这里默认为50。您可以根据定义的参
             -数，可以适当减少该值
                
                my_memset(value_string, '/0', 50);
                
                //首先获取数据类型
                if(type == 0)//参数是INT型
                {
                  value_int = data[0] << 24 | data[1] << 16 | data[2] << 8 | data[3];
                }
                else if(type == 1)
                {
                  my_strcpy(value_string, data);
                }
                
                //注意要根据所选参数类型来获得参数值！！！
                if(my_strcmp(name, "temp") == 0)
                {
                  //printf("temp value is:%d", value_int);            //int型
                }
                else if(my_strcmp(name, "humidity") == 0)
                {
                  //printf("humidity value is:%d", value_int);        //int型
                }
                else if(my_strcmp(name, "pm25") == 0)
                {
                  //printf("pm25 value is:%d", value_int);            //int型
                }
                else if(my_strcmp(name, "condition") == 0)
                {
                  //printf("condition value is:%s", value_string);    //string型
                }
              }
              #endif
 712          
 713          #ifdef WIFI_STREAM_ENABLE
              /*****************************************************************************
              函数名称 : stream_file_trans
              功能描述 : 流服务文件发送
              输入参数 : id:ID号
                        buffer:发送包的地址
                        buf_len:发送包长度
              返回参数 : 无
              *****************************************************************************/
              unsigned char stream_file_trans(unsigned int id, unsigned char *buffer, unsigned long buf_len)
              {
                #error "这里仅给出示例，请自行完善流服务处理代码,完成后请删除该行"
                unsigned short length = 0;
                unsigned long map_offset = 0;
                unsigned int pack_num = 0;
C51 COMPILER V9.57.0.0   PROTOCOL                                                          06/10/2020 17:42:50 PAGE 13  

                unsigned int rest_length = 0;
              
                if(stop_update_flag == ENABLE)
                  return SUCCESS;
              
                pack_num = buf_len / STREM_PACK_LEN;
                rest_length = buf_len - pack_num * STREM_PACK_LEN;
                if (rest_length > 0)
                {
                  pack_num++;
                }
              
                int this_len = STREM_PACK_LEN;
                for (int cnt = 0; cnt < pack_num; cnt++)
                {
                  if (cnt == pack_num - 1 && rest_length > 0)
                  {
                    this_len = rest_length;
                  }
                  else
                  {
                    this_len = STREM_PACK_LEN;
                  }
              
                  if(SUCCESS == stream_trans(id, map_offset, buffer + map_offset, this_len))
                  {
                    //mcu正在升级中，不可以进行流服务传输
                    //printf("is upgrade\n");
                    return SUCCESS;
                  }
              
                  //while(stream_status == 0xff);//收到返回
                  
                  if(stream_status != 0)
                  {
                    return ERROR;
                  }
                }
                
                return SUCCESS;
              }
              
              #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    364    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4      14
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
