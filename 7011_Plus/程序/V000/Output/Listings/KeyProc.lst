C51 COMPILER V9.57.0.0   KEYPROC                                                           06/09/2020 17:10:00 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE KEYPROC
OBJECT MODULE PLACED IN ..\Output\Objects\KeyProc.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\User\AppCode\ManageLayer\KeyProc.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR
                    -(..\User\AppCode\AppLayer;..\User\AppCode\DriverLayer;..\User\AppCode\ManageLayer;..\User\AppCode\WIFILayer;..\User\SysC
                    -ode\Core) DEBUG OBJECTEXTEND PRINT(..\Output\Listings\KeyProc.lst) OBJECT(..\Output\Objects\KeyProc.obj)

line level    source

   1          #include "KeyProc.h"
   2          #include "TypeDef.h"
   3          #include "SysDataDef.h"
   4          #include "LedProc.h"
   5          #include "wifi.h"
   6          
   7          
   8          void JudgeWorkMode(void)
   9          {
  10   1          if(AdjustLightP)
  11   1          {
  12   2              SetAdjustLightF;
  13   2          }
  14   1          else
  15   1          {
  16   2              ClrAdjustLightF;
  17   2          }
  18   1          
  19   1          if(FirstGearP)
  20   1          {
  21   2              SetFirstGearF;
  22   2              ClrSecondGearF;
  23   2              ClrThirdGearF;
  24   2          }
  25   1          else if(SecondGearP)
  26   1          {
  27   2              SetSecondGearF;
  28   2              ClrFirstGearF;
  29   2              ClrThirdGearF;
  30   2          }
  31   1          else if(ThirdGearP)
  32   1          {
  33   2              SetThirdGearF;
  34   2              ClrFirstGearF;
  35   2              ClrSecondGearF;
  36   2          }
  37   1      }
  38              
  39          UI08 KeyScan(void)
  40          {
  41   1              #define KEY_TIME        50
  42   1          
  43   1          static UI08 i = 0;
  44   1              static UI16 Count = 0;
  45   1          static UI08 key_value = 0;
  46   1      //      UI08 key_value = 0;
  47   1          
  48   1          switch(i)
  49   1          {
  50   2              case 0:
  51   2                  if(KEY1 == 0 || KEY2 == 0 || KEY3 == 0)
  52   2                  {
  53   3                      i++;  
C51 COMPILER V9.57.0.0   KEYPROC                                                           06/09/2020 17:10:00 PAGE 2   

  54   3                  }
  55   2                  break;
  56   2              
  57   2              case 1:
  58   2                  if(KEY1 == 0 || KEY2 == 0 || KEY3 == 0)
  59   2                  {
  60   3                      i++;
  61   3                      if(KEY1 == 0)       key_value = 0x01;
  62   3                      else if(KEY2 == 0)      key_value = 0x02;
  63   3                      else if(KEY3 == 0)      key_value = 0x03;
  64   3                  }
  65   2                  else
  66   2                  {
  67   3                      key_value = 0;
  68   3                      i = 0;  
  69   3                  }
  70   2                  
  71   2                  break;
  72   2              
  73   2              case 2:
  74   2                  if(KEY1 == 0 || KEY2 == 0 || KEY3 == 0)    
  75   2                  {}
  76   2                  else    // 表示都弹起来了
  77   2                  {
  78   3                      i = 0;
  79   3                      Count = 0;
  80   3                      
  81   3                      if(key_value == 0x01)       
  82   3                      {
  83   4                          key_value = 0;
  84   4                          return 0x01;
  85   4                      }
  86   3                      else if(key_value == 0x02)      
  87   3                      {
  88   4                          key_value = 0;
  89   4                          return 0x02;
  90   4                      }
  91   3                      else if(key_value == 0x03)      
  92   3                      {
  93   4                          key_value = 0;
  94   4                          return 0x03; 
  95   4                      }
  96   3                  }
  97   2                  
  98   2                  if((++Count) > KEY_TIME)
  99   2                  {
 100   3                      i++;
 101   3                  }
 102   2                  break;
 103   2                  
 104   2              case 3:
 105   2                  if((++Count) >= KEY_TIME)
 106   2                  {
 107   3                      Count = 0;
 108   3      
 109   3                      if(KEY1 == 0)       return 0x11;
 110   3                      else if(KEY2 == 0)      return 0x12;
 111   3                      else if(KEY3 == 0)      return 0x13;
 112   3                      
 113   3                      if(KEY1 == 0 || KEY2 == 0 || KEY3 == 0)
 114   3                      {}
 115   3                      else   // 表示都弹起来了 
C51 COMPILER V9.57.0.0   KEYPROC                                                           06/09/2020 17:10:00 PAGE 3   

 116   3                      {
 117   4                          key_value = 0;
 118   4                          i = 0;
 119   4                          Count = 0;
 120   4                          return 0xFF;
 121   4                      }                
 122   3                  }
 123   2                  break;
 124   2          }
 125   1          
 126   1              return 0;       // 无按键按下
 127   1      }
 128          
 129          /*****************************************************************************
 130          函数名称 : key_scan
 131          功能描述 : 扫描按键
 132          输入参数 : 无
 133          返回参数 : 无
 134          使用说明 : 无
 135          *****************************************************************************/
 136          void KeyProc(void)
 137          {
 138   1          static UI08 time_count = 0;
 139   1              UI08  key;
 140   1          UI08 wifi_state = 0;
 141   1          UI08 temp_value = 0;
 142   1          
 143   1          if(StartUpF)    return;     // 开关开启和关闭时，按键无效
 144   1          
 145   1              key = KeyScan();
 146   1              
 147   1          if(key == 0x00) return;
 148   1          
 149   1              switch(key)
 150   1              {        
 151   2                      // 开关
 152   2                      case 0X01:
 153   2      
 154   2                  if(SwitchF) 
 155   2                  {
 156   3                      ClrSwitchF;
 157   3                      SetStartUpF;
 158   3                      SetDpSwitchF;
 159   3                  }
 160   2                  else
 161   2                  {
 162   3                      SetSwitchF;
 163   3                      SetStartUpF;
 164   3                      SetDpSwitchF;
 165   3                  }
 166   2                  
 167   2      //#ifdef WIFI_TEST_ENABLE               
 168   2      //                mcu_start_wifitest();
 169   2      //#endif            
 170   2                              break;
 171   2              
 172   2              // 长按按键
 173   2              case 0x11:
 174   2                  time_count++;
 175   2                  if(time_count > 250)    time_count = 250;
 176   2              
 177   2                  if(++time_count == 12)    // 
C51 COMPILER V9.57.0.0   KEYPROC                                                           06/09/2020 17:10:00 PAGE 4   

 178   2                  {               
 179   3                      wifi_state = mcu_get_wifi_work_state();  // 获取Wifi状态
 180   3                      
 181   3                      if(wifi_state != SMART_CONFIG_STATE || wifi_state != AP_STATE)
 182   3                      {
 183   4                          mcu_reset_wifi();  // 复位wifi
 184   4                      }
 185   3                      else
 186   3                      {
 187   4                          if(wifi_state == SMART_CONFIG_STATE)
 188   4                          {
 189   5                              mcu_set_wifi_mode(AP_CONFIG);                        
 190   5                          }
 191   4                          else if(wifi_state == AP_STATE)
 192   4                          {
 193   5                              mcu_set_wifi_mode(SMART_CONFIG);
 194   5                          }
 195   4                      }
 196   3                  }
 197   2                  break;
 198   2                      
 199   2                      // 降低亮度按键
 200   2                      case 2:
 201   2              case 0x12:
 202   2                  if(!SwitchF) return;
 203   2                  
 204   2                  SetDimmerKeyF;      // 标志正在进行调灯，3s后进入配网状态
 205   2                  SetDpBrightF;       // 上报APP 调光值 将亮度值传到云服务器中
 206   2                  Face.CtrlTim = 0;
 207   2              
 208   2                  temp_value = LedShowTrans(Dimmer.FaceValue);
 209   2                  if(--temp_value < 1)  temp_value = 1;
 210   2                  
 211   2                  Dimmer.FaceValue = LightValTab[temp_value - 1];
 212   2             
 213   2                  
 214   2                  break;
 215   2                      
 216   2                      
 217   2              // 增加亮度按键
 218   2                      case 3:
 219   2                      case 0x13:
 220   2                  if(!SwitchF) return;
 221   2                  
 222   2                  SetDimmerKeyF;
 223   2                  SetDpBrightF;       // 上报APP 调光值 将亮度值传到云服务器中
 224   2                  Face.CtrlTim = 0;
 225   2              
 226   2                  temp_value = LedShowTrans(Dimmer.FaceValue);
 227   2                  if(++temp_value > 10)  temp_value = 10;
 228   2                  
 229   2                  Dimmer.FaceValue = LightValTab[temp_value - 1];         
 230   2                              break;
 231   2                      
 232   2              case 0xFF:
 233   2                  time_count = 0;
 234   2                  break;
 235   2              
 236   2                      default:
 237   2                              break;
 238   2                              
 239   2              }               
C51 COMPILER V9.57.0.0   KEYPROC                                                           06/09/2020 17:10:00 PAGE 5   

 240   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    624    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      5       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
