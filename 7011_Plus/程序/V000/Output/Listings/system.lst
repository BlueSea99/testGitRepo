C51 COMPILER V9.57.0.0   SYSTEM                                                            06/01/2020 15:26:08 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE SYSTEM
OBJECT MODULE PLACED IN ..\Output\Objects\system.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\User\AppCode\WIFILayer\system.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..
                    -\User\AppCode\AppLayer;..\User\AppCode\DriverLayer;..\User\AppCode\ManageLayer;..\User\AppCode\WIFILayer;..\User\SysCode
                    -\Core) DEBUG OBJECTEXTEND PRINT(..\Output\Listings\system.lst) OBJECT(..\Output\Objects\system.obj)

line level    source

   1          /****************************************Copyright (c)*************************
   2          **                               ç‰ˆæƒæ‰€æœ‰ (C), 2015-2020, æ¶‚é¸¦ç§‘æŠ€
   3          **
   4          **                                 http://www.tuya.com
   5          **
   6          **--------------æ–‡ä»¶ä¿¡æ¯-------------------------------------------------------
   7          **æ–‡   ä»¶   å: system.c
   8          **æ        è¿°: wifiæ•°æ®å¤„ç†å‡½æ•°
   9          **ä½¿ ç”¨ è¯´ æ˜ : ç”¨æˆ·æ— éœ€å…³å¿ƒè¯¥æ–‡ä»¶å®ç°å†…å®¹
  10          **
  11          **
  12          **--------------å½“å‰ç‰ˆæœ¬ä¿®è®¢---------------------------------------------------
  13          ** ç‰ˆ  æœ¬: v2.5.2
  14          ** æ—¥ã€€æœŸ: 2019å¹´7æœˆ5æ—¥
  15          ** æã€€è¿°: 1:å¢åŠ WiFiåŠŸèƒ½æ€§æµ‹è¯•ï¼ˆè¿æ¥æŒ‡å®šè·¯ç”±ï¼‰
  16                     2:ç®€åŒ–æµæœåŠ¡è¿‡ç¨‹ï¼Œç”¨æˆ·åªéœ€è¦è°ƒç”¨æµæœåŠ¡ä¼ è¾“æ¥å£å³å¯ä½¿ç”¨æµæœåŠ¡
  17                     3:å¢åŠ åŒæ­¥ä¸ŠæŠ¥æŒ‡ä»¤
  18                     4:å¢åŠ è·å–å½“å‰wifiè”ç½‘çŠ¶æ€æŒ‡ä»¤
  19                     5:å¢åŠ è·å–æ ¼æ—æ—¶é—´æŒ‡ä»¤
  20                     6:ä¼˜åŒ–otaå‡çº§æµç¨‹ï¼Œå¯åŠ¨otaå‡çº§æ—¶ç”¨æˆ·å¯ä»¥é€‰æ‹©ä¼ è¾“åŒ…å¤§å°
  21                     7:å¢åŠ è·å–æ¨¡å—macåœ°å€æŒ‡ä»¤
  22          
  23          ** ç‰ˆ  æœ¬: v2.5.1
  24          ** æ—¥ã€€æœŸ: 2018å¹´10æœˆ27æ—¥
  25          ** æã€€è¿°: 1:é»˜è®¤å…³é—­æµæœåŠ¡åŠŸèƒ½
  26                     2:å¢åŠ 03åè®®wifiçŠ¶æ€å®å®šä¹‰
  27                             3:æ›´æ–°ä¸ä¿®æ”¹éƒ¨åˆ†å‡½æ•°æ³¨é‡Š
  28          
  29          ** ç‰ˆ  æœ¬: v2.5.0
  30          ** æ—¥ã€€æœŸ: 2018å¹´4æœˆ18æ—¥
  31          ** æã€€è¿°: 1:åè®®ç‰ˆæœ¬æ”¹ä¸º0x03
  32                     2:å¢åŠ WIFIæ¨¡ç»„å¿ƒè·³å…³é—­åŠŸèƒ½
  33                     3:å¢åŠ å¤©æ°”åŠŸèƒ½
  34                             4:æµæœåŠ¡åŠŸèƒ½
  35          
  36          ** ç‰ˆ  æœ¬: v2.3.8
  37          ** æ—¥ã€€æœŸ: 2018å¹´1æœˆ17æ—¥
  38          ** æã€€è¿°: 1:å˜é‡æ·»åŠ volatileé˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–
  39                     2:æ·»åŠ #erroræç¤º
  40          
  41          ** ç‰ˆ  æœ¬: v2.3.7
  42          ** æ—¥ã€€æœŸ: 2017å¹´4æœˆ18æ—¥
  43          ** æã€€è¿°: 1:ä¼˜åŒ–ä¸²å£é˜Ÿåˆ—æ¥æ”¶å¤„ç†
  44                             
  45          ** ç‰ˆ  æœ¬: v2.3.6
  46          ** æ—¥ã€€æœŸ: 2016å¹´7æœˆ21æ—¥
  47          ** æã€€è¿°: 1:ä¿®å¤è·å–æœ¬åœ°æ—¶é—´é”™è¯¯
  48                     2:æ·»åŠ hex_to_bcdè½¬æ¢å‡½æ•°
  49                             
  50          ** ç‰ˆ  æœ¬: v2.3.5
  51          ** æ—¥ã€€æœŸ: 2016å¹´6æœˆ3æ—¥
  52          ** æã€€è¿°: 1:ä¿®æ”¹è¿”å›åè®®ç‰ˆæœ¬ä¸º0x01
  53                     2:å›ºä»¶å‡çº§æ•°æ®åç§»é‡ä¿®æ”¹ä¸º4å­—èŠ‚
C51 COMPILER V9.57.0.0   SYSTEM                                                            06/01/2020 15:26:08 PAGE 2   

  54          
  55          ** ç‰ˆ  æœ¬: v2.3.4
  56          ** æ—¥ã€€æœŸ: 2016å¹´5æœˆ26æ—¥
  57          ** æã€€è¿°: 1:ä¼˜åŒ–ä¸²å£è§£æå‡½æ•°
  58                     2:ä¼˜åŒ–ç¼–è¯‘å™¨å…¼å®¹æ€§,å–æ¶ˆenumç±»å‹å®šä¹‰
  59          
  60          ** ç‰ˆ  æœ¬: v2.3.3
  61          ** æ—¥ã€€æœŸ: 2016å¹´5æœˆ24æ—¥
  62          ** æã€€è¿°: 1:ä¿®æ”¹mcuè·å–æœ¬åœ°æ—¶é—´å‡½æ•°
  63                     2:æ·»åŠ wifiåŠŸèƒ½æµ‹è¯•
  64          
  65          ** ç‰ˆ  æœ¬: v2.3.2
  66          ** æ—¥ã€€æœŸ: 2016å¹´4æœˆ23æ—¥
  67          ** æã€€è¿°: 1:ä¼˜åŒ–ä¸²å£æ•°æ®è§£æ
  68                     2:ä¼˜åŒ–MCUå›ºä»¶å‡çº§æµç¨‹
  69                     3:ä¼˜åŒ–ä¸ŠæŠ¥æµç¨‹
  70          
  71          ** ç‰ˆ  æœ¬: v2.3.1
  72          ** æ—¥ã€€æœŸ: 2016å¹´4æœˆ15æ—¥
  73          ** æã€€è¿°: 1:ä¼˜åŒ–ä¸²å£æ•°æ®è§£æ
  74          
  75          ** ç‰ˆ  æœ¬: v2.3
  76          ** æ—¥ã€€æœŸ: 2016å¹´4æœˆ14æ—¥
  77          ** æã€€è¿°: 1:æ”¯æŒMCUå›ºä»¶åœ¨çº¿å‡çº§
  78          
  79          ** ç‰ˆ  æœ¬: v2.2
  80          ** æ—¥ã€€æœŸ: 2016å¹´4æœˆ11æ—¥
  81          ** æã€€è¿°: 1:ä¿®æ”¹ä¸²å£æ•°æ®æ¥æ”¶æ–¹å¼
  82          
  83          ** ç‰ˆ  æœ¬: v2.1
  84          ** æ—¥ã€€æœŸ: 2016å¹´4æœˆ8æ—¥
  85          ** æã€€è¿°: 1:åŠ å…¥æŸäº›ç¼–è¯‘å™¨ä¸æ”¯æŒå‡½æ•°æŒ‡é’ˆå…¼å®¹é€‰é¡¹
  86          
  87          ** ç‰ˆ  æœ¬: v2.0
  88          ** æ—¥ã€€æœŸ: 2016å¹´3æœˆ29æ—¥
  89          ** æã€€è¿°: 1:ä¼˜åŒ–ä»£ç ç»“æ„
  90                     2:èŠ‚çœRAMç©ºé—´
  91          **
  92          **-----------------------------------------------------------------------------
  93          ******************************************************************************/
  94          #define SYSTEM_GLOBAL
  95          
  96          #include "wifi.h"
  97          #include "protocol.h"
  98          //
  99          //
 100          extern const DOWNLOAD_CMD_S download_cmd[];
 101          unsigned short firm_size;                                                      //å‡çº§åŒ…ä¸€åŒ…çš„å¤§å°
 102          
 103          /*****************************************************************************
 104          å‡½æ•°åç§° : set_wifi_uart_byte
 105          åŠŸèƒ½æè¿° : å†™wifi_uartå­—èŠ‚
 106          è¾“å…¥å‚æ•° : dest:ç¼“å­˜åŒºå…¶å®åœ°å€;
 107                     byte:å†™å…¥å­—èŠ‚å€¼
 108          è¿”å›å‚æ•° : å†™å…¥å®Œæˆåçš„æ€»é•¿åº¦
 109          *****************************************************************************/
 110          unsigned short set_wifi_uart_byte(unsigned short dest, unsigned char byte)
 111          {
 112   1        unsigned char *obj = (unsigned char *)wifi_uart_tx_buf + DATA_START + dest;
 113   1        
 114   1        *obj = byte;
 115   1        dest += 1;
C51 COMPILER V9.57.0.0   SYSTEM                                                            06/01/2020 15:26:08 PAGE 3   

 116   1        
 117   1        return dest;
 118   1      }
 119          
 120          /*****************************************************************************
 121          å‡½æ•°åç§° : set_wifi_uart_buffer
 122          åŠŸèƒ½æè¿° : å†™wifi_uart_buffer
 123          è¾“å…¥å‚æ•° : dest:ç›®æ ‡åœ°å€
 124                     src:æºåœ°å€
 125                     len:æ•°æ®é•¿åº¦
 126          è¿”å›å‚æ•° : æ— 
 127          *****************************************************************************/
 128          unsigned short set_wifi_uart_buffer(unsigned short dest, unsigned char *src, unsigned short len)
 129          {
 130   1        unsigned char *obj = (unsigned char *)wifi_uart_tx_buf + DATA_START + dest;
 131   1        
 132   1        my_memcpy(obj,src,len);
 133   1        
 134   1        dest += len;
 135   1        return dest;
 136   1      }
 137          
 138          /*****************************************************************************
 139          å‡½æ•°åç§° : wifi_uart_write_data
 140          åŠŸèƒ½æè¿° : å‘wifi uartå†™å…¥è¿ç»­æ•°æ®
 141          è¾“å…¥å‚æ•° : in:å‘é€ç¼“å­˜æŒ‡é’ˆ
 142                     len:æ•°æ®å‘é€é•¿åº¦
 143          è¿”å›å‚æ•° : æ— 
 144          *****************************************************************************/
 145          static void wifi_uart_write_data(unsigned char *in, unsigned short len)
 146          {
 147   1        if((NULL == in) || (0 == len))
 148   1        {
 149   2          return;
 150   2        }
 151   1        
 152   1        while(len --)
 153   1        {
 154   2          uart_transmit_output(*in);
 155   2          in ++;
 156   2        }
 157   1      }
 158          
 159          /*****************************************************************************
 160          å‡½æ•°åç§° : get_check_sum
 161          åŠŸèƒ½æè¿° : è®¡ç®—æ ¡éªŒå’Œ
 162          è¾“å…¥å‚æ•° : pack:æ•°æ®æºæŒ‡é’ˆ
 163                     pack_len:è®¡ç®—æ ¡éªŒå’Œé•¿åº¦
 164          è¿”å›å‚æ•° : æ ¡éªŒå’Œ
 165          *****************************************************************************/
 166          unsigned char get_check_sum(unsigned char *pack, unsigned short pack_len)
 167          {
 168   1        unsigned short i;
 169   1        unsigned char check_sum = 0;
 170   1        
 171   1        for(i = 0; i < pack_len; i ++)
 172   1        {
 173   2          check_sum += *pack ++;
 174   2        }
 175   1        
 176   1        return check_sum;
 177   1      }
C51 COMPILER V9.57.0.0   SYSTEM                                                            06/01/2020 15:26:08 PAGE 4   

 178          
 179          /*****************************************************************************
 180          å‡½æ•°åç§° : wifi_uart_write_frame
 181          åŠŸèƒ½æè¿° : å‘wifiä¸²å£å‘é€ä¸€å¸§æ•°æ®
 182          è¾“å…¥å‚æ•° : fr_type:å¸§ç±»å‹
 183                     len:æ•°æ®é•¿åº¦
 184          è¿”å›å‚æ•° : æ— 
 185          *****************************************************************************/
 186          void wifi_uart_write_frame(unsigned char fr_type, unsigned short len)
 187          {
 188   1        unsigned char check_sum = 0;
 189   1        
 190   1        wifi_uart_tx_buf[HEAD_FIRST] = 0x55;
 191   1        wifi_uart_tx_buf[HEAD_SECOND] = 0xaa;
 192   1        wifi_uart_tx_buf[PROTOCOL_VERSION] = 0x03;
 193   1        wifi_uart_tx_buf[FRAME_TYPE] = fr_type;
 194   1        wifi_uart_tx_buf[LENGTH_HIGH] = len >> 8;
 195   1        wifi_uart_tx_buf[LENGTH_LOW] = len & 0xff;
 196   1        
 197   1        len += PROTOCOL_HEAD;
 198   1        check_sum = get_check_sum((unsigned char *)wifi_uart_tx_buf, len - 1);
 199   1        wifi_uart_tx_buf[len - 1] = check_sum;
 200   1      
 201   1        wifi_uart_write_data((unsigned char *)wifi_uart_tx_buf, len);
 202   1      }
 203          
 204          /*****************************************************************************
 205          å‡½æ•°åç§° : heat_beat_check
 206          åŠŸèƒ½æè¿° : å¿ƒè·³åŒ…æ£€æµ‹
 207          è¾“å…¥å‚æ•° : æ— 
 208          è¿”å›å‚æ•° : æ— 
 209          *****************************************************************************/
 210          static void heat_beat_check(void)
 211          {
 212   1        unsigned char length = 0;
 213   1        static unsigned char mcu_reset_state = FALSE;
 214   1        
 215   1        if(FALSE == mcu_reset_state)
 216   1        {
 217   2          length = set_wifi_uart_byte(length,FALSE);
 218   2          mcu_reset_state = TRUE;
 219   2        }
 220   1        else
 221   1        {
 222   2          length = set_wifi_uart_byte(length,TRUE);
 223   2        }
 224   1        
 225   1        wifi_uart_write_frame(HEAT_BEAT_CMD, length);
 226   1      }
 227          
 228          /*****************************************************************************
 229          å‡½æ•°åç§°  : product_info_update
 230          åŠŸèƒ½æè¿°  : äº§å“ä¿¡æ¯ä¸Šä¼ 
 231          è¾“å…¥å‚æ•° : æ— 
 232          è¿”å›å‚æ•° : æ— 
 233          *****************************************************************************/
 234          static void product_info_update(void)
 235          {
 236   1        unsigned char length = 0;
 237   1        
 238   1        length = set_wifi_uart_buffer(length, "{\"p\":\"", my_strlen("{\"p\":\""));
 239   1        length = set_wifi_uart_buffer(length,(unsigned char *)PRODUCT_KEY,my_strlen((unsigned char *)PRODUCT_KEY
C51 COMPILER V9.57.0.0   SYSTEM                                                            06/01/2020 15:26:08 PAGE 5   

             -));
 240   1        length = set_wifi_uart_buffer(length, "\",\"v\":\"", my_strlen("\",\"v\":\""));
 241   1        length = set_wifi_uart_buffer(length,(unsigned char *)MCU_VER,my_strlen((unsigned char *)MCU_VER));
 242   1        length = set_wifi_uart_buffer(length, "\",\"m\":", my_strlen("\",\"m\":"));
 243   1        length = set_wifi_uart_buffer(length, (unsigned char *)CONFIG_MODE, my_strlen((unsigned char *)CONFIG_MO
             -DE));
 244   1        length = set_wifi_uart_buffer(length, "}", my_strlen("}"));
 245   1        
 246   1        wifi_uart_write_frame(PRODUCT_INFO_CMD, length);
 247   1      }
 248          
 249          /*****************************************************************************
 250          å‡½æ•°åç§° : get_mcu_wifi_mode
 251          åŠŸèƒ½æè¿° : æŸ¥è¯¢mcuå’Œwifiçš„å·¥ä½œæ¨¡å¼
 252          è¾“å…¥å‚æ•° : æ— 
 253          è¿”å›å‚æ•° : æ— 
 254          *****************************************************************************/
 255          static void get_mcu_wifi_mode(void)
 256          {
 257   1        unsigned char length = 0;
 258   1        
 259   1      #ifdef WIFI_CONTROL_SELF_MODE                                                   //æ¨¡å—è‡ªå¤„ç†
                length = set_wifi_uart_byte(length, WF_STATE_KEY);    
                length = set_wifi_uart_byte(length, WF_RESERT_KEY);   
              #else                                                           
 263   1        //æ— éœ€å¤„ç†æ•°æ®
 264   1      #endif
 265   1      
 266   1        wifi_uart_write_frame(WORK_MODE_CMD, length);
 267   1      }
 268          
 269          /*****************************************************************************
 270          å‡½æ•°åç§° : get_update_dpid_index
 271          åŠŸèƒ½æè¿° : è·å–åˆ¶å®šDPIDåœ¨æ•°ç»„ä¸­çš„åºå·
 272          è¾“å…¥å‚æ•° : dpid:dpid
 273          è¿”å›å‚æ•° : index:dpåºå·
 274          *****************************************************************************/
 275          static unsigned char get_dowmload_dpid_index(unsigned char dpid)
 276          {
 277   1        unsigned char index;
 278   1        unsigned char total = get_download_cmd_total();
 279   1        
 280   1        for(index = 0; index < total; index ++)
 281   1        {
 282   2          if(download_cmd[index].dp_id == dpid)
 283   2          {
 284   3            break;
 285   3          }
 286   2        }
 287   1        
 288   1        return index;
 289   1      }
 290          /*****************************************************************************
 291          å‡½æ•°åç§° : data_point_handle
 292          åŠŸèƒ½æè¿° : ä¸‹å‘æ•°æ®å¤„ç†
 293          è¾“å…¥å‚æ•° : value:ä¸‹å‘æ•°æ®æºæŒ‡é’ˆ
 294          è¿”å›å‚æ•° : ret:è¿”å›æ•°æ®å¤„ç†ç»“æœ
 295          *****************************************************************************/
 296          static unsigned char data_point_handle(const unsigned char value[])
 297          {
 298   1        unsigned char dp_id,index;
 299   1        unsigned char dp_type;
C51 COMPILER V9.57.0.0   SYSTEM                                                            06/01/2020 15:26:08 PAGE 6   

 300   1        unsigned char ret;
 301   1        unsigned short dp_len;
 302   1        
 303   1        dp_id = value[0];
 304   1        dp_type = value[1];
 305   1        dp_len = value[2] * 0x100;
 306   1        dp_len += value[3];
 307   1        
 308   1        index = get_dowmload_dpid_index(dp_id);
 309   1      
 310   1        if(dp_type != download_cmd[index].dp_type)
 311   1        {
 312   2          //é”™è¯¯æç¤º
 313   2          return FALSE;
 314   2        }
 315   1        else
 316   1        {
 317   2          ret = dp_download_handle(dp_id,value + 4,dp_len);
 318   2        }
 319   1        
 320   1        return ret;
 321   1      }
 322          
 323          #ifdef WEATHER_ENABLE
              /*****************************************************************************
              å‡½æ•°åç§° : data_point_handle
              åŠŸèƒ½æè¿° : ä¸‹å‘æ•°æ®å¤„ç†
              è¾“å…¥å‚æ•° : value:ä¸‹å‘æ•°æ®æºæŒ‡é’ˆ
              è¿”å›å‚æ•° : ret:è¿”å›æ•°æ®å¤„ç†ç»“æœ
              *****************************************************************************/
              void mcu_open_weather(void)
              {
                int i = 0;
                char temp[10], buffer[13] = "xw.xxxxxxxxxx";
                char result[WEATHER_CHOOSE_CNT * 13 + 8];
                int buf_len = 0, now_buf_len = 0, last_buf_len = 0;
                int weather_len = 0;
                unsigned char check_sum = 0;
                
                weather_len = sizeof(weather_choose);
                weather_len = sizeof(weather_choose) / 10;
                
                for(i=0;i<weather_len;i++)
                {
                  my_memcpy(temp, weather_choose[i], strlen(weather_choose[i]));
                  my_memcpy(buffer + 3, temp, strlen(weather_choose[i]));
                  buffer[0] = strlen(weather_choose[i]) + 2;
                  buf_len = strlen(weather_choose[i]) + 3;
                  now_buf_len += buf_len;
                  my_memcpy(result + DATA_START + last_buf_len, buffer, buf_len);
                  last_buf_len = now_buf_len;
                }
                
                result[HEAD_FIRST] = 0x55;
                result[HEAD_SECOND] = 0xaa;
                result[PROTOCOL_VERSION] = 0x03;
                result[FRAME_TYPE] = 0x20;
                result[LENGTH_HIGH] = now_buf_len >> 8;
                result[LENGTH_LOW] = now_buf_len & 0xff;
                
                now_buf_len += PROTOCOL_HEAD;
                check_sum = get_check_sum((unsigned char *)result, now_buf_len - 1);
C51 COMPILER V9.57.0.0   SYSTEM                                                            06/01/2020 15:26:08 PAGE 7   

                result[now_buf_len - 1] = check_sum;
                
                wifi_uart_write_data((unsigned char *)result, now_buf_len);
              }
              
              /*****************************************************************************
              å‡½æ•°åç§° : weather_data_raw_handle
              åŠŸèƒ½æè¿° : å¤©æ°”æ•°æ®è§£æ
              è¾“å…¥å‚æ•° : buffer:æ¥æ”¶æ•°æ®æŒ‡é’ˆ
              è¿”å›å‚æ•° : æ— 
              *****************************************************************************/
              void weather_data_raw_handle(char *buffer)
              {
                char return_send_Weather[7] = { 0x55, 0xaa, 0x00, 0x21, 0x00, 0x00, 0x20 };
                int length = buffer[LENGTH_HIGH] * 256 + buffer[LENGTH_LOW];
                int i = 7;
                int can_len = 0; 
                char can[15] = "";
                int type1 = 0;
                char value_string[100] = "";
                int val_cnt = 0;
                int val_len = 0;
                
                if(buffer[DATA_START] != 1 || length < 1)
                {
                  //æ¥æ”¶å¤±è´¥
                }
                else
                {
                  if(length < 4)
                  {
                    //æ•°æ®ä¸ºç©º
                  }
                  
                  while (i < length + 7 - 1)
                  {
                    can_len = buffer[i];
                    my_memset(can, '\0', 15);
                    my_memcpy(can, buffer + i + 1, can_len);
              
                    type1 = buffer[i + 1 + can_len];
                    if(type1 != 0 && type1 != 1)
                    {
                      return;
                    }
              
                    my_memset(value_string, '\0', 100);
                    val_cnt = i + 1 + can_len + 1 + 1 - 1;
                    val_len = buffer[val_cnt];
                    if (type1 == 0)
                    {//int32
                      weather_data_user_handle(can+2, type1, buffer+val_cnt+1);
                    }
                    else if(type1 == 1)
                    {//string
                      my_memcpy(value_string, buffer + val_cnt + 1, val_len);
                      weather_data_user_handle(can+2, type1, value_string);
                    }
              
                    i += 1 + can_len + 1 + val_len + 1;
                  }
                  
C51 COMPILER V9.57.0.0   SYSTEM                                                            06/01/2020 15:26:08 PAGE 8   

                  my_memcpy((unsigned char *)wifi_uart_tx_buf, return_send_Weather, 7);
                  wifi_uart_write_data((unsigned char *)wifi_uart_tx_buf, 7);
                }
              }
              #endif
 429          
 430          /*****************************************************************************
 431          å‡½æ•°åç§° : data_handle
 432          åŠŸèƒ½æè¿° : æ•°æ®å¸§å¤„ç†
 433          è¾“å…¥å‚æ•° : offset:æ•°æ®èµ·å§‹ä½
 434          è¿”å›å‚æ•° : æ— 
 435          *****************************************************************************/
 436          void data_handle(unsigned short offset)
 437          {
 438   1      #ifdef SUPPORT_MCU_FIRM_UPDATE
                  unsigned char *firmware_addr;
                  static unsigned long firm_length;                                             //MCUå‡çº§æ–‡ä»¶é•¿åº¦
                  static unsigned char firm_update_flag;                                        //MCUå‡çº§æ ‡å¿—
                  unsigned long dp_len;
                  unsigned char firm_flag;                                                      //å‡çº§åŒ…å¤§å°æ ‡å¿—
              #else
 445   1          unsigned short dp_len;
 446   1      #endif
 447   1        
 448   1          unsigned char ret;
 449   1          unsigned short i,total_len;
 450   1          unsigned char cmd_type = wifi_uart_rx_buf[offset + FRAME_TYPE];
 451   1      
 452   1      #ifdef WEATHER_ENABLE
                  static unsigned char isWoSend = 0;                    //æ˜¯å¦å·²ç»æ‰“å¼€è¿‡å¤©æ°”æ•°æ®,0:æ˜¯;1:å¦
              #endif
 455   1      
 456   1      #ifdef WIFI_TEST_ENABLE
 457   1          unsigned char result;
 458   1          unsigned char rssi;
 459   1      #endif
 460   1        
 461   1          switch(cmd_type)
 462   1          {
 463   2              case HEAT_BEAT_CMD:             // 0 å¿ƒè·³åŒ… (æ¨¡ç»„å‘é€ï¼ŒMCUä¸ŠæŠ¥ï¼ŒæˆåŠŸåˆ™æ¨¡ç»„é—´éš”15
             -så‘é€ä¸€æ¬¡)
 464   2                  heat_beat_check();
 465   2              break;
 466   2          
 467   2              case PRODUCT_INFO_CMD:          // 1 äº§å“ä¿¡æ¯ (æ¨¡ç»„å‘é€ï¼ŒMCUä¸ŠæŠ¥ï¼ŒPIDå·/mcuç‰ˆæœ¬å·/
             -é…ç½‘æ–¹å¼)
 468   2                  product_info_update();
 469   2                  break;
 470   2          
 471   2              case WORK_MODE_CMD:             // 2 æŸ¥è¯¢MCUè®¾å®šçš„æ¨¡å—å·¥ä½œæ¨¡å¼ (ï¼Ÿæ¨¡ç»„å‘é€ï¼ŒMCUä¸
             -ŠæŠ¥)
 472   2                  get_mcu_wifi_mode();
 473   2                  break;
 474   2          
 475   2      #ifndef WIFI_CONTROL_SELF_MODE
 476   2              case WIFI_STATE_CMD:            // 3 æŠ¥å‘Šwifiå·¥ä½œçŠ¶æ€     
 477   2                  wifi_work_state = wifi_uart_rx_buf[offset + DATA_START];
 478   2                  wifi_uart_write_frame(WIFI_STATE_CMD,0);
 479   2        
 480   2      #ifdef WEATHER_ENABLE                   
                      if(wifi_work_state == WIFI_CONNECTED && isWoSend == 0)   
                      {
C51 COMPILER V9.57.0.0   SYSTEM                                                            06/01/2020 15:26:08 PAGE 9   

                        mcu_open_weather();
                        isWoSend = 1;
                      }
              #endif
 487   2          break;
 488   2      
 489   2        case WIFI_RESET_CMD:                  // 4 é‡ç½®wifi(wifiè¿”å›æˆåŠŸ)
 490   2          reset_wifi_flag = RESET_WIFI_SUCCESS;
 491   2          break;
 492   2          
 493   2        case WIFI_MODE_CMD:                   // 5 é€‰æ‹©smartconfig/APæ¨¡å¼(wifiè¿”å›æˆåŠŸ)       
 494   2          set_wifimode_flag = SET_WIFICONFIG_SUCCESS;
 495   2          break;
 496   2      #endif
 497   2          
 498   2        case DATA_QUERT_CMD:                  // 6 å¹¿æ’­ (æ¨¡ç»„å‘é€ï¼ŒMCUä¸ŠæŠ¥ï¼Œè‡ªå®šä¹‰çš„æ•°æ®å¦‚äº®åº
             -¦ï¼Œå¼€å…³é‡)
 499   2          total_len = wifi_uart_rx_buf[offset + LENGTH_HIGH] * 0x100;
 500   2          total_len += wifi_uart_rx_buf[offset + LENGTH_LOW];
 501   2          
 502   2          for(i = 0;i < total_len;)
 503   2          {
 504   3            dp_len = wifi_uart_rx_buf[offset + DATA_START + i + 2] * 0x100;
 505   3            dp_len += wifi_uart_rx_buf[offset + DATA_START + i + 3];
 506   3      
 507   3            ret = data_point_handle((unsigned char *)wifi_uart_rx_buf + offset + DATA_START + i);
 508   3            
 509   3            if(SUCCESS == ret)
 510   3            {
 511   4              //æˆåŠŸæç¤º
 512   4            }
 513   3            else
 514   3            {
 515   4              //é”™è¯¯æç¤º
 516   4            }
 517   3            
 518   3            i += (dp_len + 4);
 519   3          }
 520   2          
 521   2          break;
 522   2          
 523   2        case STATE_QUERY_CMD:     // 8 çŠ¶æ€æŸ¥è¯¢
 524   2          all_data_update();                               
 525   2          break;
 526   2      
 527   2      #ifdef SUPPORT_MCU_FIRM_UPDATE
                case UPDATE_START_CMD:    //å‡çº§å¼€å§‹
                  //è·å–å‡çº§åŒ…å¤§å°å…¨å±€å˜é‡
                  firm_flag = PACKAGE_SIZE;
                  if(firm_flag == 0) {
                    firm_size = 256;
                  }else if(firm_flag == 1) {
                    firm_size = 512;
                  }else if(firm_flag == 2) { 
                    firm_size = 1024;
                  }
              
                  firm_length = wifi_uart_rx_buf[offset + DATA_START];
                  firm_length <<= 8;
                  firm_length |= wifi_uart_rx_buf[offset + DATA_START + 1];
                  firm_length <<= 8;
                  firm_length |= wifi_uart_rx_buf[offset + DATA_START + 2];
C51 COMPILER V9.57.0.0   SYSTEM                                                            06/01/2020 15:26:08 PAGE 10  

                  firm_length <<= 8;
                  firm_length |= wifi_uart_rx_buf[offset + DATA_START + 3];
                  
                  upgrade_package_choose(PACKAGE_SIZE);
                  firm_update_flag = UPDATE_START_CMD;
                   break;
                  
                case UPDATE_TRANS_CMD:    //å‡çº§ä¼ è¾“
                  if(firm_update_flag == UPDATE_START_CMD)
                  {
                    //åœæ­¢ä¸€åˆ‡æ•°æ®ä¸ŠæŠ¥
                    stop_update_flag = ENABLE;
                    
                    total_len = wifi_uart_rx_buf[offset + LENGTH_HIGH] * 0x100;
                    total_len += wifi_uart_rx_buf[offset + LENGTH_LOW];
                    
                    dp_len = wifi_uart_rx_buf[offset + DATA_START];
                    dp_len <<= 8;
                    dp_len |= wifi_uart_rx_buf[offset + DATA_START + 1];
                    dp_len <<= 8;
                    dp_len |= wifi_uart_rx_buf[offset + DATA_START + 2];
                    dp_len <<= 8;
                    dp_len |= wifi_uart_rx_buf[offset + DATA_START + 3];
                    
                    firmware_addr = (unsigned char *)wifi_uart_rx_buf;
                    firmware_addr += (offset + DATA_START + 4);
                    
                    if((total_len == 4) && (dp_len == firm_length))
                    {
                      //æœ€åä¸€åŒ…
                      ret = mcu_firm_update_handle(firmware_addr,dp_len,0);
                      
                      firm_update_flag = 0;
                    }
                    else if((total_len - 4) <= firm_size)
                    {
                      ret = mcu_firm_update_handle(firmware_addr,dp_len,total_len - 4);
                    }
                    else
                    {
                      firm_update_flag = 0;
                      ret = ERROR;
                    }
                    
                    if(ret == SUCCESS)
                    {
                      wifi_uart_write_frame(UPDATE_TRANS_CMD,0);
                    }
                    //æ¢å¤ä¸€åˆ‡æ•°æ®ä¸ŠæŠ¥
                    stop_update_flag = DISABLE;    
                  }
                  break;
              #endif      
 597   2      
 598   2      #ifdef SUPPORT_GREEN_TIME
                case GET_ONLINE_TIME_CMD:                              //è·å–æ ¼æ—æ—¶é—´
                  mcu_get_greentime((unsigned char *)(wifi_uart_rx_buf + offset + DATA_START));
                break;
              #endif
 603   2      
 604   2      #ifdef SUPPORT_MCU_RTC_CHECK
                case GET_LOCAL_TIME_CMD:                             //è·å–æœ¬åœ°æ—¶é—´
C51 COMPILER V9.57.0.0   SYSTEM                                                            06/01/2020 15:26:08 PAGE 11  

                    mcu_write_rtctime((unsigned char *)(wifi_uart_rx_buf + offset + DATA_START));
                  break;
              #endif
 609   2       
 610   2      #ifdef WIFI_TEST_ENABLE
 611   2        case WIFI_TEST_CMD:                                   // 0x0e wifiåŠŸèƒ½æµ‹è¯•ï¼ˆæ‰«ææŒ‡å®šè·¯ç”±ï¼‰
 612   2          result = wifi_uart_rx_buf[offset + DATA_START];
 613   2          rssi = wifi_uart_rx_buf[offset + DATA_START + 1];
 614   2          wifi_test_result(result, rssi);
 615   2          break;
 616   2      #endif
 617   2      
 618   2      #ifdef WEATHER_ENABLE
                case WEATHER_OPEN_CMD:
                  weather_open_return_handle(wifi_uart_rx_buf[offset + DATA_START], wifi_uart_rx_buf[offset + DATA_START
             - + 1]);
                  
                  break;
                  
                case WEATHER_DATA_CMD:
                  weather_data_raw_handle((char*)wifi_uart_rx_buf + offset);
                  break;
              #endif
 628   2      
 629   2      #ifdef WIFI_STREAM_ENABLE
                case STREAM_TRANS_CMD:
                  stream_status = wifi_uart_rx_buf[offset + DATA_START];//æµæœåŠ¡ä¼ è¾“è¿”å›æ¥æ”¶
                  break;
                
              #endif
 635   2      
 636   2      #ifdef WIFI_CONNECT_TEST_ENABLE
                    case WIFI_CONNECT_TEST_CMD:                           // wifiåŠŸèƒ½æµ‹è¯•ï¼ˆè¿æ¥æŒ‡å®šè·¯ç”±ï¼‰
                      result = wifi_uart_rx_buf[offset + DATA_START];
                      wifi_connect_test_result(result);
                      break;
              #endif
 642   2      
 643   2      #ifdef GET_MODULE_MAC_ENABLE
                    case GET_MAC_CMD:                                     // è·å–æ¨¡å—mac
                      mcu_get_mac((unsigned char *)(wifi_uart_rx_buf + offset + DATA_START));
                    break;
              #endif
 648   2      
 649   2      #ifdef GET_WIFI_STATUS_ENABLE
                    case GET_WIFI_STATUS_CMD:                             // è·å–å½“å‰wifiè”ç½‘çŠ¶æ€
                        wifi_work_state = wifi_uart_rx_buf[offset + DATA_START];
                    break;
              #endif
 654   2      
 655   2      #ifdef MCU_DP_UPLOAD_SYN
                    case STATE_UPLOAD_SYN_RECV_CMD:                             //çŠ¶æ€ä¸ŠæŠ¥ï¼ˆåŒæ­¥ï¼‰
                      result = wifi_uart_rx_buf[offset + DATA_START];
                      get_upload_syn_result(result);
                    break;
                    
              #endif
 662   2          
 663   2        default:
 664   2          break;
 665   2        }
 666   1      }
C51 COMPILER V9.57.0.0   SYSTEM                                                            06/01/2020 15:26:08 PAGE 12  

 667          
 668          /*****************************************************************************
 669          å‡½æ•°åç§° : get_queue_total_data
 670          åŠŸèƒ½æè¿° : è¯»å–é˜Ÿåˆ—å†…æ•°æ®
 671          è¾“å…¥å‚æ•° : æ— 
 672          è¿”å›å‚æ•° : æ— 
 673          *****************************************************************************/
 674          unsigned char get_queue_total_data(void)
 675          {
 676   1        if(queue_in != queue_out)
 677   1          return 1;
 678   1        else
 679   1          return 0;
 680   1      }
 681          /*****************************************************************************
 682          å‡½æ•°åç§° : Queue_Read_Byte
 683          åŠŸèƒ½æè¿° : è¯»å–é˜Ÿåˆ—1å­—èŠ‚æ•°æ®
 684          è¾“å…¥å‚æ•° : æ— 
 685          è¿”å›å‚æ•° : æ— 
 686          *****************************************************************************/
 687          unsigned char Queue_Read_Byte(void)
 688          {
 689   1        unsigned char value;
 690   1        
 691   1        if(queue_out != queue_in)
 692   1        {
 693   2          //æœ‰æ•°æ®
 694   2          if(queue_out >= (unsigned char *)(wifi_queue_buf + sizeof(wifi_queue_buf)))
 695   2          {
 696   3            //æ•°æ®å·²ç»åˆ°æœ«å°¾
 697   3            queue_out = (unsigned char *)(wifi_queue_buf);
 698   3          }
 699   2          
 700   2          value = *queue_out ++;   
 701   2        }
 702   1        
 703   1        return value;
 704   1      }
 705          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1407    ----
   CONSTANT SIZE    =     49    ----
   XDATA SIZE       =    122      40
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
