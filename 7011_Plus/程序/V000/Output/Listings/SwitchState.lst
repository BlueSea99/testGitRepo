C51 COMPILER V9.57.0.0   SWITCHSTATE                                                       05/28/2020 16:39:36 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE SWITCHSTATE
OBJECT MODULE PLACED IN ..\Output\Objects\SwitchState.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ..\User\AppCode\ManageLayer\SwitchState.c LARGE OPTIMIZE(8,SPEED) BROWSE IN
                    -CDIR(..\User\AppCode\AppLayer;..\User\AppCode\DriverLayer;..\User\AppCode\ManageLayer;..\User\AppCode\WIFILayer;..\User\
                    -SysCode\Core) DEBUG OBJECTEXTEND PRINT(..\Output\Listings\SwitchState.lst) OBJECT(..\Output\Objects\SwitchState.obj)

line level    source

   1          #include "SwitchState.h"
   2          #include "Typedef.h"
   3          #include "SysDataDef.h"
   4          
   5          UI08 LedShowTrans(UI16 Value)
   6          {
   7   1          UI08 show_value = 0;
   8   1          
   9   1          if(Value < 25)
  10   1          {
  11   2              show_value = 0;
  12   2          }
  13   1          else if(Value >= 25 && Value < 50)
  14   1          {
  15   2              show_value = 1;
  16   2          }
  17   1          else if(Value >= 50 && Value < 75)
  18   1          {
  19   2              show_value = 2;
  20   2          }
  21   1          else if(Value >= 75 && Value < 100)
  22   1          {
  23   2              show_value = 3;
  24   2          }
  25   1          else if(Value >= 100 && Value < 125)
  26   1          {
  27   2              show_value = 4;
  28   2          } 
  29   1          else if(Value >= 125 && Value < 150)
  30   1          {
  31   2              show_value = 5;
  32   2          }
  33   1          else if(Value >= 150 && Value < 175)
  34   1          {
  35   2              show_value = 6;
  36   2          }
  37   1          else if(Value >= 175 && Value < 200)
  38   1          {
  39   2              show_value = 7;
  40   2          }
  41   1          else if(Value >= 200 && Value < 225)
  42   1          {
  43   2              show_value = 8;
  44   2          } 
  45   1          else if(Value >= 225 && Value < 250)
  46   1          {
  47   2              show_value = 9;
  48   2          }
  49   1          else if(Value >= 250)
  50   1          {
  51   2              show_value = 10;
  52   2          }
  53   1          
C51 COMPILER V9.57.0.0   SWITCHSTATE                                                       05/28/2020 16:39:36 PAGE 2   

  54   1          return show_value;
  55   1      }
  56          
  57          void SwitchStateProc(void)
  58          {
  59   1              switch(Face.State)
  60   1          {
  61   2              case STEP_IDLE:
  62   2                  if(SwitchF)
  63   2                  {
  64   3                      Face.CtrlTim = 0;
  65   3                      Face.State = STEP_OPENDRELAY;
  66   3                  }
  67   2                  else
  68   2                  {
  69   3                      if(!NetSuccessF)    // 如果配网不成功，3s后进入配网状态
  70   3                      {
  71   4                          if(++Face.CtrlTim > 4000)
  72   4                          {                        
  73   5                              Face.CtrlTim = 0;
  74   5                              Face.State = STEP_NETWORK;
  75   5                          }
  76   4                      }
  77   3                  }
  78   2                  break;
  79   2              
  80   2              case STEP_OPENDRELAY:
  81   2                  OpenSwitchP;
  82   2                  Dig[0] = 20;
  83   2                  if(++Face.CtrlTim > 1000)            // 延时1000ms，防止继电器打开时灯闪烁
  84   2                  {
  85   3                      Face.CtrlTim = 0;
  86   3                      Dimmer.TmepValue = Dimmer.Step; //控制启动时开始电压
  87   3                      Face.State = STEP_ADDBRIGHT;
  88   3                  }
  89   2                  break;
  90   2                  
  91   2              case STEP_ADDBRIGHT:
  92   2                  SetPwmTriggerF;
  93   2      
  94   2                  if(Dimmer.TmepValue < Dimmer.FaceValue)
  95   2                  {
  96   3                      if(++Face.CtrlTim > 10)     // 控制启动灯亮度速率
  97   3                      {
  98   4                          Face.CtrlTim = 0;
  99   4                          Dimmer.TmepValue ++;
 100   4                          Dig[0] = LedShowTrans(Dimmer.TmepValue);
 101   4                      }
 102   3                  }
 103   2                  else
 104   2                  {
 105   3                      Face.CtrlTim = 0;
 106   3                      Face.State = STEP_DIMMER;
 107   3                      ClrStartUpF;
 108   3                  }
 109   2                  break;
 110   2              
 111   2              case STEP_DIMMER:
 112   2                  Dig[0] = LedShowTrans(Dimmer.FaceValue);
 113   2                  
 114   2                  if(Dimmer.TmepValue > Dimmer.Step)
 115   2                  {
C51 COMPILER V9.57.0.0   SWITCHSTATE                                                       05/28/2020 16:39:36 PAGE 3   

 116   3                      if(++Face.CtrlTim > 10)     // 控制灯熄灭的速率
 117   3                      {
 118   4                          Face.CtrlTim = 0;
 119   4                          
 120   4                          Dimmer.TmepValue--;
 121   4                      }
 122   3                  }
 123   2                  else
 124   2                  {
 125   3                      if(++Face.CtrlTim > 10)     // 控制灯熄灭的速率
 126   3                      {
 127   4                          Face.CtrlTim = 0;
 128   4                          
 129   4                          Dimmer.TmepValue++;
 130   4                      }
 131   3                  }
 132   2                  
 133   2                  if(!NetSuccessF)    // 如果配网不成功，3s进入配网状态
 134   2                  {
 135   3                      Face.CtrlTim++;
 136   3                      if(Face.CtrlTim > 4000)
 137   3                      {
 138   4                          Face.CtrlTim = 0;
 139   4                          ClrDimmerKeyF;
 140   4                          
 141   4                          Face.State = STEP_NETWORK;
 142   4                      }
 143   3                  }
 144   2                  
 145   2                  if(!SwitchF)
 146   2                  {
 147   3                      Face.CtrlTim = 0;
 148   3                      Face.State = STEP_FALLBRIGHT;
 149   3                  }
 150   2                  break;
 151   2              
 152   2              case STEP_NETWORK:
 153   2                  SetAllFlashF;
 154   2                  if(SlowFlashF)      // 慢闪
 155   2                  {
 156   3                      Dig[0] = 8;
 157   3                  }
 158   2                  else if(FastFlashF) // 快闪
 159   2                  {
 160   3                      Dig[0] = 11;
 161   3                  }
 162   2                  
 163   2                  if(StartUpF)        // 配网状态进入启动状态
 164   2                  {
 165   3                      if(SwitchF)
 166   3                      {
 167   4                          Face.State = STEP_OPENDRELAY;
 168   4                      }
 169   3                      else
 170   3                      {
 171   4                          Face.State = STEP_FALLBRIGHT;
 172   4                      }
 173   3                      ClrAllFlashF;
 174   3                      Face.CtrlTim = 0;
 175   3                  }
 176   2                  
 177   2                  if(DimmerKeyF)
C51 COMPILER V9.57.0.0   SWITCHSTATE                                                       05/28/2020 16:39:36 PAGE 4   

 178   2                  {
 179   3                      ClrAllFlashF;
 180   3                      Face.CtrlTim = 0;
 181   3                      Face.State = STEP_DIMMER; 
 182   3                  }
 183   2                  break;
 184   2              
 185   2              case STEP_FALLBRIGHT:
 186   2                  if(Dimmer.TmepValue > Dimmer.Step)
 187   2                  {
 188   3                      if(++Face.CtrlTim > 10)     // 控制灯熄灭的速率
 189   3                      {
 190   4                          Face.CtrlTim = 0;
 191   4                          
 192   4                          Dimmer.TmepValue --;
 193   4                          Dig[0] = LedShowTrans(Dimmer.TmepValue);
 194   4                      }
 195   3                  }
 196   2                  else
 197   2                  {
 198   3                      SetPwmF;
 199   3                      ClrPwmTriggerF;
 200   3                      Face.CtrlTim = 0;
 201   3                      Face.State = STEP_CLOSERELAY;
 202   3                  }
 203   2                  break;
 204   2                  
 205   2              case STEP_CLOSERELAY:
 206   2                  if(++Face.CtrlTim > 1000)
 207   2                  {
 208   3                      Dig[0] = 20;
 209   3                      CloseSwitchP;
 210   3                      Face.CtrlTim = 0;
 211   3                      Face.State = STEP_IDLE;
 212   3                      ClrStartUpF;                
 213   3                  }
 214   2                  break;
 215   2                  
 216   2              default:
 217   2                  Face.CtrlTim = 0;
 218   2                  Face.State = STEP_IDLE;
 219   2                  break;
 220   2          }
 221   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    942    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
